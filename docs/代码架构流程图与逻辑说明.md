# Smart RTSP Stream Manager - ä»£ç æ¶æ„æµç¨‹å›¾ä¸é€»è¾‘åŠŸèƒ½è¯´æ˜

> æœ¬æ–‡æ¡£åŸºäºå½“å‰é‡æ„åçš„ä»£ç ç»“æ„ï¼Œä½¿ç”¨ FastAPI åˆ†å±‚æ¶æ„æœ€ä½³å®è·µï¼Œè¯¦ç»†è¯´æ˜ç³»ç»Ÿæ¶æ„ã€æ•°æ®æµç¨‹å’Œä¸šåŠ¡é€»è¾‘ã€‚
> 
> **æœ€åæ›´æ–°**: 2025-12-20
> **æ–‡æ¡£ç‰ˆæœ¬**: 2.0.0

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [æŠ€æœ¯æ ˆè¯¦è§£](#æŠ€æœ¯æ ˆè¯¦è§£)
3. [åˆ†å±‚æ¶æ„è®¾è®¡](#åˆ†å±‚æ¶æ„è®¾è®¡)
4. [æ ¸å¿ƒä¸šåŠ¡æµç¨‹](#æ ¸å¿ƒä¸šåŠ¡æµç¨‹)
5. [æ•°æ®æ¨¡å‹å…³ç³»](#æ•°æ®æ¨¡å‹å…³ç³»)
6. [åå°ä»»åŠ¡æœºåˆ¶](#åå°ä»»åŠ¡æœºåˆ¶)
7. [API ç«¯ç‚¹è¯´æ˜](#api-ç«¯ç‚¹è¯´æ˜)
8. [å‰ç«¯æ¶æ„](#å‰ç«¯æ¶æ„)
9. [å…³é”®é€»è¾‘è¯´æ˜](#å…³é”®é€»è¾‘è¯´æ˜)
10. [æ€§èƒ½ä¼˜åŒ–è¦ç‚¹](#æ€§èƒ½ä¼˜åŒ–è¦ç‚¹)
11. [å®‰å…¨è€ƒè™‘](#å®‰å…¨è€ƒè™‘)
12. [æ‰©å±•æ€§è®¾è®¡](#æ‰©å±•æ€§è®¾è®¡)

---

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph "å®¢æˆ·ç«¯å±‚"
        WEB[Webå‰ç«¯<br/>å•é¡µåº”ç”¨ SPA]
        API_CLIENT[APIå®¢æˆ·ç«¯]
    end
    
    subgraph "FastAPI åº”ç”¨å±‚"
        MAIN[main.py<br/>åº”ç”¨å…¥å£]
        LIFESPAN[Lifespan<br/>ç”Ÿå‘½å‘¨æœŸç®¡ç†]
        DEPS[dependencies.py<br/>ä¾èµ–æ³¨å…¥]
    end
    
    subgraph "è·¯ç”±å±‚ (Routers)"
        R_TASKS[tasks.py<br/>ä»»åŠ¡ç®¡ç†]
        R_IMAGES[images.py<br/>å›¾ç‰‡ç®¡ç†]
        R_AUTO[auto_schedule.py<br/>è‡ªåŠ¨è°ƒåº¦]
        R_UTILS[utils.py<br/>å·¥å…·ç±»]
        R_PARKING[parking_changes.py<br/>è½¦ä½å˜åŒ–]
    end
    
    subgraph "æœåŠ¡å±‚ (Services)"
        S_TASK[TaskService<br/>ä»»åŠ¡ä¸šåŠ¡é€»è¾‘]
        S_IMAGE[ImageService<br/>å›¾ç‰‡ä¸šåŠ¡é€»è¾‘]
        S_AUTO[AutoScheduleService<br/>è°ƒåº¦ä¸šåŠ¡é€»è¾‘]
        S_UTILS[UtilsService<br/>å·¥å…·ä¸šåŠ¡é€»è¾‘]
        S_CLEANUP[TaskCleanupService<br/>æ¸…ç†ä¸šåŠ¡é€»è¾‘]
        S_PARKING[ParkingChangeService<br/>è½¦ä½å˜åŒ–ä¸šåŠ¡é€»è¾‘]
    end
    
    subgraph "ä»“åº“å±‚ (Repositories)"
        REPO_TASK[TaskRepository<br/>ä»»åŠ¡æ•°æ®è®¿é—®]
        REPO_IMAGE[ImageRepository<br/>å›¾ç‰‡æ•°æ®è®¿é—®]
        REPO_AUTO[AutoScheduleRepository<br/>è°ƒåº¦æ•°æ®è®¿é—®]
        REPO_PARKING[ParkingChangeRepository<br/>è½¦ä½å˜åŒ–æ•°æ®è®¿é—®]
    end
    
    subgraph "æ•°æ®å±‚"
        DB[(MySQLæ•°æ®åº“<br/>SQLAlchemy ORM)]
        FS[æ–‡ä»¶ç³»ç»Ÿ<br/>screenshots/hls/models]
    end
    
    subgraph "å·¥å…·æœåŠ¡å±‚ (Services)"
        SEGMENT[segment_generator<br/>ä»»åŠ¡åˆ†ç‰‡ç”Ÿæˆ]
        SCREENSHOT[screenshot<br/>RTSPæˆªå›¾]
        STREAM_CHECK[stream_check<br/>RTSPæµæ£€æŸ¥]
        STREAM_HLS[stream_hls<br/>HLSè½¬æ¢]
        YOLO[yolo_detector<br/>YOLOv8è½¦è¾†æ£€æµ‹]
    end
    
    subgraph "å¤–éƒ¨æœåŠ¡"
        RTSP[RTSPæµæº<br/>ç½‘ç»œæ‘„åƒå¤´]
        FFMPEG[FFmpeg<br/>HLSè½¬æ¢]
    end
    
    subgraph "åå°ä»»åŠ¡ (Background Workers)"
        BG_SCHEDULE[å®šæ—¶è°ƒåº¦å™¨<br/>æ¯åˆ†é’Ÿæ£€æŸ¥è§„åˆ™]
        BG_PENDING[å¾…è¿è¡Œä»»åŠ¡æ£€æŸ¥å™¨<br/>æ¯5ç§’æ£€æŸ¥]
        BG_RETRY[å¤±è´¥é‡è¯•æ£€æŸ¥å™¨<br/>æ¯å°æ—¶æ£€æŸ¥]
        BG_YOLO[è½¦ä½å˜åŒ–æ£€æµ‹å™¨<br/>æ¯5ç§’å¤„ç†æˆªå›¾]
    end
    
    WEB --> MAIN
    API_CLIENT --> MAIN
    MAIN --> LIFESPAN
    MAIN --> DEPS
    MAIN --> R_TASKS
    MAIN --> R_IMAGES
    MAIN --> R_AUTO
    MAIN --> R_UTILS
    MAIN --> R_PARKING
    
    R_TASKS --> S_TASK
    R_IMAGES --> S_IMAGE
    R_AUTO --> S_AUTO
    R_UTILS --> S_UTILS
    R_PARKING --> S_PARKING
    
    S_TASK --> REPO_TASK
    S_TASK --> S_CLEANUP
    S_IMAGE --> REPO_IMAGE
    S_AUTO --> REPO_AUTO
    S_PARKING --> REPO_PARKING
    
    REPO_TASK --> DB
    REPO_IMAGE --> DB
    REPO_AUTO --> DB
    REPO_PARKING --> DB
    
    S_TASK --> SEGMENT
    S_TASK --> SCREENSHOT
    S_TASK --> STREAM_CHECK
    S_UTILS --> STREAM_HLS
    S_PARKING --> YOLO
    
    SCREENSHOT --> RTSP
    STREAM_HLS --> FFMPEG
    YOLO --> FS
    
    S_IMAGE --> FS
    S_UTILS --> FS
    
    LIFESPAN --> BG_SCHEDULE
    LIFESPAN --> BG_PENDING
    LIFESPAN --> BG_RETRY
    LIFESPAN --> BG_YOLO
    
    BG_SCHEDULE --> S_TASK
    BG_PENDING --> S_TASK
    BG_RETRY --> S_TASK
    BG_YOLO --> YOLO
    BG_YOLO --> REPO_PARKING
```

### æŠ€æœ¯æ ˆ

#### åç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **FastAPI** | >=0.110.0 | Webæ¡†æ¶ï¼Œæä¾›RESTful API |
| **SQLAlchemy** | >=2.0.0 | ORMæ¡†æ¶ï¼Œæ•°æ®åº“æ“ä½œ |
| **PyMySQL** | >=1.1.0 | MySQLæ•°æ®åº“é©±åŠ¨ |
| **Pydantic** | >=2.5.0 | æ•°æ®éªŒè¯å’Œåºåˆ—åŒ– |
| **Uvicorn** | >=0.29.0 | ASGIæœåŠ¡å™¨ |
| **OpenCV** | >=4.10.0.84 | å›¾åƒå¤„ç†ï¼ˆæˆªå›¾ã€ç»˜åˆ¶ï¼‰ |
| **Ultralytics** | >=8.0.0 | YOLOv8ç›®æ ‡æ£€æµ‹ |
| **NumPy** | >=1.24.0 | æ•°å€¼è®¡ç®— |
| **Pillow** | >=10.0.0 | å›¾åƒå¤„ç†åº“ |

#### å‰ç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç”¨é€” |
|------|------|
| **åŸç”ŸJavaScript** | å‰ç«¯é€»è¾‘å®ç° |
| **HTML5/CSS3** | é¡µé¢ç»“æ„å’Œæ ·å¼ |
| **HLS.js** | HLSè§†é¢‘æµæ’­æ”¾ |
| **Flatpickr** | æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨ |

#### å¤–éƒ¨å·¥å…·

| å·¥å…· | ç”¨é€” |
|------|------|
| **FFmpeg** | RTSPæµè½¬æ¢ã€HLSç”Ÿæˆ |
| **MySQL** | å…³ç³»å‹æ•°æ®åº“ |

#### æ¶æ„æ¨¡å¼

- **åˆ†å±‚æ¶æ„**ï¼šRouter â†’ Service â†’ Repository â†’ Model
- **Repository Pattern**ï¼šæ•°æ®è®¿é—®å±‚æŠ½è±¡
- **ä¾èµ–æ³¨å…¥**ï¼šFastAPI Dependsæœºåˆ¶
- **åå°ä»»åŠ¡**ï¼šç‹¬ç«‹çº¿ç¨‹æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡
- **å•ä¾‹æ¨¡å¼**ï¼šYOLOæ¨¡å‹å…¨å±€å•ä¾‹

---

## åˆ†å±‚æ¶æ„è®¾è®¡

### æ¶æ„åˆ†å±‚è¯´æ˜

é‡‡ç”¨ **FastAPI åˆ†å±‚æ¶æ„æœ€ä½³å®è·µ**ï¼Œéµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Layer (Routers)                 â”‚  HTTPè¯·æ±‚å¤„ç†ã€å‚æ•°éªŒè¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Service Layer (Business Logic)      â”‚  ä¸šåŠ¡é€»è¾‘ã€æ•°æ®éªŒè¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Repository Layer (Data Access)     â”‚  æ•°æ®åº“æ“ä½œå°è£…
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Model Layer (Database)             â”‚  æ•°æ®æ¨¡å‹å®šä¹‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1. è·¯ç”±å±‚ (Routers)

**èŒè´£**: å¤„ç† HTTP è¯·æ±‚å’Œå“åº”ï¼Œå‚æ•°éªŒè¯ï¼Œè°ƒç”¨æœåŠ¡å±‚

**ä½ç½®**: `app/routers/`

| æ¨¡å— | æ–‡ä»¶ | ç«¯ç‚¹æ•°é‡ | ä¸»è¦åŠŸèƒ½ |
|------|------|---------|---------|
| ä»»åŠ¡ç®¡ç† | `tasks.py` | 11ä¸ª | ä»»åŠ¡åˆ›å»ºã€æŸ¥è¯¢ã€è¿è¡Œã€åˆ é™¤ã€é‡è¯• |
| å›¾ç‰‡ç®¡ç† | `images.py` | 4ä¸ª | å›¾ç‰‡æŸ¥è¯¢ã€ä»£ç†ã€å¯ç”¨æ—¥æœŸã€OCRæŸ¥è¯¢ |
| è‡ªåŠ¨è°ƒåº¦ | `auto_schedule.py` | 4ä¸ª | è§„åˆ™ CRUDã€å¯ç”¨/ç¦ç”¨ |
| å·¥å…·ç±» | `utils.py` | 6ä¸ª | HLSã€å¥åº·æ£€æŸ¥ã€å›¾ç‰‡ä»£ç†ã€é¦–é¡µã€ç®¡ç†æ¥å£ |
| è½¦ä½å˜åŒ– | `parking_changes.py` | 4ä¸ª | è½¦ä½å˜åŒ–æŸ¥è¯¢ã€åˆ†ç»„æŸ¥è¯¢ã€åˆ†ææŠ¥å‘Šã€è¯¦æƒ… |

**ç‰¹ç‚¹**:
- ä½¿ç”¨ FastAPI `APIRouter` ç»„ç»‡è·¯ç”±
- é€šè¿‡ `Depends(get_db)` æ³¨å…¥æ•°æ®åº“ä¼šè¯
- å‚æ•°éªŒè¯ä½¿ç”¨ Pydantic æ¨¡å‹
- è¿”å›æ ‡å‡†åŒ–çš„ JSON å“åº”
- æ”¯æŒæŸ¥è¯¢å‚æ•°è¿‡æ»¤ã€åˆ†é¡µã€æ’åº

**è·¯ç”±æ³¨å†Œ**:
```python
app.include_router(images.router)
app.include_router(auto_schedule.router)
app.include_router(utils.router)
app.include_router(parking_changes.router)
# tasks.py çš„è·¯ç”±åœ¨ main.py ä¸­ç›´æ¥å®šä¹‰ï¼ˆå†å²åŸå› ï¼‰
```

### 2. æœåŠ¡å±‚ (Services)

**èŒè´£**: å°è£…ä¸šåŠ¡é€»è¾‘ï¼Œæ•°æ®éªŒè¯ï¼Œè°ƒç”¨ä»“åº“å±‚å’Œå¤–éƒ¨æœåŠ¡

**ä½ç½®**: `app/services/`

| æœåŠ¡ | æ–‡ä»¶ | ä¸»è¦åŠŸèƒ½ |
|------|------|---------|
| TaskService | `task_service.py` | ä»»åŠ¡åˆ›å»ºã€æŸ¥è¯¢ã€è¿è¡Œé€»è¾‘ã€çŠ¶æ€ç®¡ç† |
| ImageService | `image_service.py` | å›¾ç‰‡æŸ¥è¯¢ã€URLæ„å»ºã€çŠ¶æ€æ ‡ç­¾ã€ç¼ºå¤±æ£€æŸ¥ |
| AutoScheduleService | `auto_schedule_service.py` | è§„åˆ™éªŒè¯ã€åç§°ç”Ÿæˆã€CRUDã€æ‰§è¡Œç®¡ç† |
| UtilsService | `utils_service.py` | HLSå¯åŠ¨ã€å¥åº·æ£€æŸ¥ã€OCRæŸ¥è¯¢ã€å›¾ç‰‡ä»£ç† |
| TaskCleanupService | `task_cleanup_service.py` | ä»»åŠ¡æ¸…ç†ã€æ•°æ®åˆ é™¤ã€æ–‡ä»¶æ¸…ç† |
| ParkingChangeService | `parking_change_service.py` | è½¦ä½å˜åŒ–æŸ¥è¯¢ã€åˆ†ç»„ã€åˆ†ææŠ¥å‘Šç”Ÿæˆ |

**ç‰¹ç‚¹**:
- ä¸šåŠ¡é€»è¾‘ä¸è·¯ç”±è§£è€¦
- å¯ç‹¬ç«‹æµ‹è¯•
- å¯å¤ç”¨ï¼ˆå¤šä¸ªè·¯ç”±å¯è°ƒç”¨åŒä¸€æœåŠ¡ï¼‰
- é›†ä¸­å¤„ç†éªŒè¯å’Œé”™è¯¯å¤„ç†
- æ”¯æŒå¤æ‚ä¸šåŠ¡é€»è¾‘ç»„åˆ

### 3. ä»“åº“å±‚ (Repositories)

**èŒè´£**: å°è£…æ•°æ®åº“æ“ä½œï¼Œæä¾›ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£

**ä½ç½®**: `app/repositories/`

| ä»“åº“ | æ–‡ä»¶ | ä¸»è¦æ“ä½œ |
|------|------|---------|
| TaskRepository | `task_repository.py` | ä»»åŠ¡ CRUDã€å¤æ‚æŸ¥è¯¢ã€çŠ¶æ€åè°ƒã€æ‰¹é‡æ“ä½œ |
| ImageRepository | `image_repository.py` | æˆªå›¾æŸ¥è¯¢ã€æ‰¹é‡è·å–ã€æ—¥æœŸç»Ÿè®¡ã€æ–‡ä»¶æ£€æŸ¥ |
| AutoScheduleRepository | `auto_schedule_repository.py` | è§„åˆ™ CRUDã€æ‰§è¡Œä¿¡æ¯æ›´æ–°ã€å¯ç”¨çŠ¶æ€ç®¡ç† |
| ParkingChangeRepository | `parking_change_repository.py` | è½¦ä½å˜åŒ–æŸ¥è¯¢ã€åˆ†ç»„ã€å†å²çŠ¶æ€æŸ¥æ‰¾ã€æ—¶é—´åºåˆ—åˆ†æ |

**ç‰¹ç‚¹**:
- ä½¿ç”¨ Repository Pattern
- å°è£… SQLAlchemy æŸ¥è¯¢
- æä¾›é«˜çº§æŸ¥è¯¢æ–¹æ³•ï¼ˆè¿‡æ»¤ã€åˆ†é¡µã€æ’åºï¼‰
- æ”¯æŒæ‰¹é‡æ“ä½œ
- å¤„ç†å¤æ‚å…³è”æŸ¥è¯¢
- æ—¶é—´åºåˆ—æŸ¥è¯¢ä¼˜åŒ–

### 4. æ•°æ®æ¨¡å‹å±‚ (Models)

**ä½ç½®**: `models.py`

| æ¨¡å‹ | è¡¨å | å…³é”®å­—æ®µ | å…³ç³» |
|------|------|---------|------|
| TaskBatch | `task_batches` | date, ip, channel, status | 1:N Task |
| Task | `tasks` | date, rtsp_url, status, start_ts, end_ts | N:1 TaskBatch, 1:N Screenshot |
| Screenshot | `screenshots` | task_id, file_path, yolo_status | N:1 Task, 1:1 OcrResult |
| OcrResult | `ocr_results` | screenshot_id, detected_time | N:1 Screenshot |
| AutoScheduleRule | `auto_schedule_rules` | trigger_time, is_enabled | 1:N TaskBatch |
| NvrConfig | `nvr_configs` | nvr_ip, parking_name | 1:N ChannelConfig |
| ChannelConfig | `channel_configs` | nvr_config_id, channel_code, track_space | N:1 NvrConfig, 1:N ParkingSpace |
| ParkingSpace | `parking_spaces` | channel_config_id, space_name, bbox_* | N:1 ChannelConfig |
| ParkingChange | `parking_changes` | screenshot_id, space_id, change_type | N:1 Screenshot, N:1 ParkingSpace |
| ParkingChangeSnapshot | `parking_change_snapshots` | screenshot_id, change_count | N:1 Screenshot |

**å…³ç³»è¯´æ˜**:
- æ‰€æœ‰æ¨¡å‹ç»§æ‰¿è‡ª `Base`ï¼ˆSQLAlchemy declarative_baseï¼‰
- ä½¿ç”¨ `relationship` å®šä¹‰ORMå…³ç³»
- å¤–é”®çº¦æŸæ”¯æŒçº§è”åˆ é™¤ï¼ˆCASCADEï¼‰æˆ–è®¾ä¸ºNULLï¼ˆSET NULLï¼‰

### 5. å·¥å…·æœåŠ¡å±‚ (Services)

**ä½ç½®**: `services/`

| æœåŠ¡ | æ–‡ä»¶ | ä¸»è¦åŠŸèƒ½ |
|------|------|---------|
| segment_generator | `segment_generator.py` | æŒ‰æ—¶é—´é—´éš”ç”Ÿæˆä»»åŠ¡åˆ†ç‰‡ |
| screenshot | `screenshot.py` | RTSPæµæˆªå›¾ã€æ–‡ä»¶ä¿å­˜ |
| stream_check | `stream_check.py` | RTSPæµå¯ç”¨æ€§æ£€æŸ¥ |
| stream_hls | `stream_hls.py` | RTSPè½¬HLSæµè½¬æ¢ |
| yolo_detector | `yolo_detector.py` | YOLOv8è½¦è¾†æ£€æµ‹ã€æ¨¡å‹ç®¡ç† |

**ç‰¹ç‚¹**:
- ç‹¬ç«‹çš„åŠŸèƒ½æ¨¡å—
- å¯è¢«å¤šä¸ªæœåŠ¡å±‚è°ƒç”¨
- å°è£…å¤–éƒ¨ä¾èµ–ï¼ˆFFmpegã€OpenCVã€YOLOï¼‰
- æä¾›ç»Ÿä¸€çš„æ¥å£

---

## æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 1. ä»»åŠ¡åˆ›å»ºæµç¨‹

```mermaid
sequenceDiagram
    participant Client
    participant Router as tasks.py
    participant Service as TaskService
    participant Repo as TaskRepository
    participant SegmentGen as segment_generator
    participant RTSP as stream_check
    participant DB as Database
    
    Client->>Router: POST /api/tasks/create
    Router->>Service: ensure_tasks(req)
    
    Service->>SegmentGen: build_segment_tasks()
    SegmentGen-->>Service: segments[] (144ä¸ªä»»åŠ¡æ®µ)
    
    Service->>RTSP: check_rtsp(first_url)
    RTSP-->>Service: ok/error (ä»…è­¦å‘Šï¼Œä¸é˜»å¡)
    
    Service->>Repo: get_tasks_by_filters()
    Repo->>DB: SELECT tasks WHERE date=? AND ip=? AND channel=?
    DB-->>Repo: existing_tasks[]
    Repo-->>Service: existing_tasks[]
    
    alt ä»»åŠ¡å·²å­˜åœ¨
        Service->>Service: æ¸…ç†æ—§ä»»åŠ¡ï¼ˆåˆ é™¤ä»»åŠ¡ã€æˆªå›¾ã€OCRï¼‰
        Service->>Repo: delete_tasks_by_filters()
        Repo->>DB: DELETE tasks, screenshots, ocr_results
    end
    
    Service->>Repo: create_batch(segments)
    Repo->>DB: INSERT task_batches
    Repo->>DB: INSERT tasks (æ‰¹é‡)
    DB-->>Repo: task_ids[]
    Repo-->>Service: TaskCreateResponse
    
    Service->>Service: è‡ªåŠ¨å¯åŠ¨è¿è¡Œï¼ˆåå°çº¿ç¨‹ï¼‰
    Service-->>Router: TaskCreateResponse
    Router-->>Client: 201 Created
```

**å…³é”®æ­¥éª¤**:
1. **å‚æ•°éªŒè¯**: éªŒè¯æ—¥æœŸã€RTSPåœ°å€ã€é€šé“æ ¼å¼
2. **ç”Ÿæˆåˆ†ç‰‡**: æŒ‰10åˆ†é’Ÿé—´éš”ç”Ÿæˆ144ä¸ªä»»åŠ¡æ®µï¼ˆä¸€å¤©24å°æ—¶ï¼‰
3. **RTSPæ£€æŸ¥**: éªŒè¯æµå¯ç”¨æ€§ï¼ˆä»…è­¦å‘Šï¼Œä¸é˜»å¡åˆ›å»ºï¼‰
4. **æ¸…ç†æ—§ä»»åŠ¡**: å¦‚æœä»»åŠ¡å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤æ—§ä»»åŠ¡ã€æˆªå›¾å’ŒOCRè®°å½•
5. **æ‰¹é‡åˆ›å»º**: åˆ›å»ºä»»åŠ¡æ‰¹æ¬¡ï¼ˆTaskBatchï¼‰å’Œä»»åŠ¡æ˜ç»†ï¼ˆTaskï¼‰
6. **è‡ªåŠ¨è¿è¡Œ**: åˆ›å»ºåè‡ªåŠ¨å¯åŠ¨ä»»åŠ¡æ‰§è¡Œï¼ˆåå°çº¿ç¨‹ï¼‰

### 2. ä»»åŠ¡æ‰§è¡Œæµç¨‹

```mermaid
sequenceDiagram
    participant BG as Background Runner
    participant Service as TaskService
    participant Repo as TaskRepository
    participant ThreadPool as ThreadPoolExecutor
    participant Capture as screenshot.capture_frame
    participant RTSP as RTSP Stream
    participant FS as File System
    participant DB as Database
    participant YOLO as YOLO Worker
    
    BG->>Service: æ£€æµ‹åˆ°å¾…è¿è¡Œä»»åŠ¡
    Service->>Repo: get_pending_or_playing_tasks()
    Repo->>DB: SELECT tasks WHERE status IN ('pending','playing')
    DB-->>Repo: tasks[]
    Repo-->>Service: tasks[]
    
    Service->>Service: æŒ‰ç»„åˆåˆ†ç»„ (date, base_rtsp, channel)
    Service->>ThreadPool: æäº¤ä»»åŠ¡ç»„åˆï¼ˆä¿¡å·é‡æ§åˆ¶å¹¶å‘ï¼‰
    
    par å¹¶è¡Œå¤„ç†å¤šä¸ªç»„åˆï¼ˆæœ€å¤š4ä¸ªï¼‰
        ThreadPool->>Service: å¤„ç†ç»„åˆ1
        Service->>Repo: update_status_batch('playing')
        Repo->>DB: UPDATE tasks SET status='playing'
        
        loop å¤„ç†æ¯ä¸ªä»»åŠ¡æ®µï¼ˆå¹¶è¡Œï¼‰
            Service->>Capture: capture_frame(rtsp_url)
            Capture->>RTSP: è¿æ¥RTSPæµ
            RTSP-->>Capture: è§†é¢‘å¸§
            Capture->>FS: ä¿å­˜æˆªå›¾æ–‡ä»¶
            Capture->>DB: INSERT/UPDATE screenshots
            Capture->>DB: UPDATE task SET screenshot_path=?
            
            alt æˆªå›¾æˆåŠŸ
                Service->>Repo: update_task_status('completed')
                Repo->>DB: UPDATE task SET status='completed'
                
                Note over YOLO: å¼‚æ­¥å¤„ç†
                YOLO->>DB: UPDATE screenshot SET yolo_status='pending'
            else æˆªå›¾å¤±è´¥
                Service->>Repo: update_task_status('failed')
                Repo->>DB: UPDATE task SET status='failed', error=?
            end
        end
    end
    
    ThreadPool-->>Service: æ‰§è¡Œå®Œæˆ
    Service-->>BG: ä»»åŠ¡å®Œæˆ
```

**å…³é”®æ­¥éª¤**:
1. **ä»»åŠ¡æ£€æµ‹**: åå°æ£€æŸ¥å™¨å®šæœŸæ‰«æå¾…è¿è¡Œä»»åŠ¡ï¼ˆæ¯5ç§’ï¼‰
2. **ç»„åˆåˆ†ç»„**: æŒ‰ (date, base_rtsp, channel) åˆ†ç»„
3. **å¹¶å‘æ§åˆ¶**: ä½¿ç”¨ä¿¡å·é‡é™åˆ¶å¹¶å‘æ•°ï¼ˆMAX_COMBO_CONCURRENCY=4ï¼‰
4. **æ‰¹é‡æ ‡è®°**: å¼€å§‹å‰æ‰¹é‡æ ‡è®°ä¸º `playing`
5. **å¹¶è¡Œæˆªå›¾**: ä½¿ç”¨çº¿ç¨‹æ± å¹¶è¡Œå¤„ç†å¤šä¸ªä»»åŠ¡æ®µ
6. **çŠ¶æ€æ›´æ–°**: æ¯ä¸ªä»»åŠ¡å®Œæˆåç«‹å³æ›´æ–°çŠ¶æ€
7. **å¼‚æ­¥YOLO**: æˆªå›¾æˆåŠŸåï¼ŒYOLO Workerå¼‚æ­¥å¤„ç†è½¦ä½æ£€æµ‹

### 3. è½¦ä½å˜åŒ–æ£€æµ‹æµç¨‹

```mermaid
sequenceDiagram
    participant BG as YOLO Worker
    participant Worker as parking_change_worker
    participant YOLO as yolo_detector
    participant Repo as ParkingChangeRepository
    participant DB as Database
    participant FS as File System
    
    BG->>Worker: æ‰«æ yolo_status='pending' çš„æˆªå›¾
    Worker->>DB: SELECT screenshots WHERE yolo_status='pending'
    DB-->>Worker: screenshots[]
    
    loop å¤„ç†æ¯å¼ æˆªå›¾
        Worker->>DB: è·å– Taskã€ChannelConfigã€ParkingSpace
        Worker->>FS: è¯»å–æˆªå›¾æ–‡ä»¶
        
        loop å¤„ç†æ¯ä¸ªè½¦ä½
            Worker->>YOLO: detect_cars_in_region(è½¦ä½åæ ‡)
            YOLO->>FS: è£å‰ªè½¦ä½åŒºåŸŸ
            YOLO->>YOLO: YOLOv8æ£€æµ‹
            YOLO-->>Worker: (has_vehicle, confidence)
        end
        
        Worker->>Worker: _detect_space_occupancy() (æ‰€æœ‰è½¦ä½)
        Worker->>FS: _draw_detection_regions() (ç»˜åˆ¶æ£€æµ‹åŒºåŸŸ)
        
        loop å¯¹æ¯”å†å²çŠ¶æ€
            Worker->>Repo: _get_prev_occupied_for_channel()
            Repo->>DB: æŸ¥è¯¢ä¸Šä¸€å¼ æˆªå›¾çš„çŠ¶æ€ï¼ˆæŒ‰æ—¶é—´é¡ºåºï¼‰
            DB-->>Repo: prev_occupied, prev_screenshot_id
            Repo-->>Worker: prev_occupied, prev_screenshot_id
            
            Worker->>Worker: å¤šå¸§ç¡®è®¤æœºåˆ¶
            Worker->>Worker: åˆ¤æ–­å˜åŒ–ç±»å‹ (arrive/leave/None)
        end
        
        Worker->>DB: INSERT parking_changes (æ‰€æœ‰è½¦ä½çŠ¶æ€)
        
        alt æœ‰å˜åŒ– (change_count > 0)
            Worker->>DB: INSERT parking_change_snapshots
        end
        
        Worker->>DB: UPDATE screenshot SET yolo_status='done'
    end
```

**å…³é”®æ­¥éª¤**:
1. **æ‰«æå¾…å¤„ç†æˆªå›¾**: æŸ¥è¯¢ `yolo_status='pending'` çš„æˆªå›¾
2. **è·å–é…ç½®**: è·å–é€šé“é…ç½®å’Œè½¦ä½åæ ‡
3. **åŒºåŸŸæ£€æµ‹**: å¯¹æ¯ä¸ªè½¦ä½åŒºåŸŸè¿›è¡ŒYOLOæ£€æµ‹
4. **å†å²å¯¹æ¯”**: æŒ‰æ—¶é—´é¡ºåºæŸ¥æ‰¾ä¸Šä¸€å¼ æˆªå›¾çš„çŠ¶æ€
5. **å¤šå¸§ç¡®è®¤**: æ£€æŸ¥å‰2å¸§çŠ¶æ€ï¼Œå‡å°‘è¯¯åˆ¤
6. **è®°å½•å˜åŒ–**: è®°å½•æ‰€æœ‰è½¦ä½çŠ¶æ€åˆ° `parking_changes`
7. **ç”Ÿæˆå¿«ç…§**: å¦‚æœæœ‰å˜åŒ–ï¼Œç”Ÿæˆ `parking_change_snapshots` è®°å½•
8. **ç»˜åˆ¶æ ‡è®°**: åœ¨å›¾ç‰‡ä¸Šç»˜åˆ¶æ£€æµ‹åŒºåŸŸï¼ˆç»¿è‰²æ¡†ï¼‰

### 4. å›¾ç‰‡æŸ¥è¯¢æµç¨‹

```mermaid
sequenceDiagram
    participant Client
    participant Router as images.py
    participant Service as ImageService
    participant Repo as ImageRepository
    participant DB as Database
    participant FS as File System
    
    Client->>Router: GET /api/images?date=2025-12-20&task_ip=10.10.11.123
    Router->>Service: list_images(filters)
    
    Service->>Repo: get_tasks_with_filters()
    Repo->>DB: SELECT tasks WHERE date=? AND ip=?
    DB-->>Repo: tasks[]
    Repo-->>Service: tasks[]
    
    Service->>Repo: get_screenshot_dict_by_task_ids()
    Repo->>DB: SELECT screenshots WHERE task_id IN (?)
    DB-->>Repo: screenshots[]
    Repo-->>Service: screenshot_dict{}
    
    loop éå†æ¯ä¸ªä»»åŠ¡
        Service->>Service: get_status_label(task, shot)
        Service->>Service: build_image_url(path, prefer_detected=True)
        Service->>FS: æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        FS-->>Service: exists/missing
        
        Service->>Service: åº”ç”¨è¿‡æ»¤æ¡ä»¶
        Note over Service: åç§°è¿‡æ»¤ã€çŠ¶æ€è¿‡æ»¤ã€ç¼ºå¤±è¿‡æ»¤
    end
    
    Service->>Service: å…³è”è½¦ä½å˜åŒ–ä¿¡æ¯
    Service-->>Router: {date, count, items[]}
    Router-->>Client: 200 OK
```

**å…³é”®æ­¥éª¤**:
1. **ä»»åŠ¡æŸ¥è¯¢**: æ ¹æ®è¿‡æ»¤æ¡ä»¶æŸ¥è¯¢ä»»åŠ¡
2. **æ‰¹é‡è·å–æˆªå›¾**: ä¸€æ¬¡æ€§è·å–æ‰€æœ‰ç›¸å…³æˆªå›¾
3. **çŠ¶æ€åˆ¤æ–­**: æ ¹æ®ä»»åŠ¡çŠ¶æ€å’Œæˆªå›¾æƒ…å†µç¡®å®šæ˜¾ç¤ºçŠ¶æ€
4. **URLæ„å»º**: æ„å»ºå›¾ç‰‡è®¿é—®URLï¼ˆä¼˜å…ˆä½¿ç”¨ `_detected.jpg`ï¼‰
5. **æ–‡ä»¶æ£€æŸ¥**: æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œæ ‡è®° missing
6. **è¿‡æ»¤åº”ç”¨**: åº”ç”¨åç§°ã€çŠ¶æ€ã€ç¼ºå¤±ç­‰è¿‡æ»¤æ¡ä»¶
7. **å…³è”å˜åŒ–**: å…³è”è½¦ä½å˜åŒ–ä¿¡æ¯ï¼ˆæ˜¯å¦æœ‰å˜åŒ–ï¼‰

### 5. è‡ªåŠ¨è°ƒåº¦æµç¨‹

```mermaid
sequenceDiagram
    participant Client
    participant Router as auto_schedule.py
    participant Service as AutoScheduleService
    participant Repo as AutoScheduleRepository
    participant DB as Database
    participant BG as Background Scheduler
    participant TaskService as TaskService
    
    Client->>Router: POST /api/auto-schedule/rules
    Router->>Service: create_rule(rule_data)
    
    Service->>Service: validate_rule_data()
    Note over Service: éªŒè¯æ—¥æœŸã€æ—¶é—´ã€RTSPã€é€šé“ã€é—´éš”
    
    Service->>Service: generate_rule_name()
    Service->>Repo: create(rule)
    Repo->>DB: INSERT auto_schedule_rules
    DB-->>Repo: rule_id
    Repo-->>Service: rule
    Service-->>Router: {id, message}
    Router-->>Client: 200 OK
    
    Note over BG: æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    
    BG->>Repo: get_enabled_rules()
    Repo->>DB: SELECT rules WHERE is_enabled=true
    DB-->>Repo: rules[]
    Repo-->>BG: rules[]
    
    loop éå†æ¯ä¸ªè§„åˆ™
        BG->>BG: æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦åŒ¹é… trigger_time
        BG->>BG: æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²æ‰§è¡Œè¿‡
        
        alt æ—¶é—´åŒ¹é…ä¸”æœªæ‰§è¡Œ
            BG->>TaskService: ensure_tasks()
            TaskService->>TaskService: åˆ›å»ºä»»åŠ¡æ‰¹æ¬¡
            TaskService->>TaskService: è¿è¡Œä»»åŠ¡
            
            alt æ‰§è¡ŒæˆåŠŸ
                BG->>Repo: update_execution_info(success)
                Repo->>DB: UPDATE rule SET last_executed_at=?, execution_count+=1
            else æ‰§è¡Œå¤±è´¥
                BG->>Repo: update_execution_info(failed, error)
                Repo->>DB: UPDATE rule SET last_execution_status='failed', last_execution_error=?
            end
        end
    end
```

**å…³é”®æ­¥éª¤**:
1. **è§„åˆ™åˆ›å»º**: éªŒè¯å¹¶åˆ›å»ºè°ƒåº¦è§„åˆ™
2. **å®šæ—¶æ£€æŸ¥**: åå°çº¿ç¨‹æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
3. **æ—¶é—´åŒ¹é…**: æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦åŒ¹é…è§„åˆ™çš„è§¦å‘æ—¶é—´
4. **é˜²é‡å¤æ‰§è¡Œ**: æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²æ‰§è¡Œè¿‡
5. **è‡ªåŠ¨æ‰§è¡Œ**: åŒ¹é…åè‡ªåŠ¨åˆ›å»ºå¹¶è¿è¡Œä»»åŠ¡
6. **æ‰§è¡Œè®°å½•**: è®°å½•æ‰§è¡Œç»“æœå’Œé”™è¯¯ä¿¡æ¯

---

## æ•°æ®æ¨¡å‹å…³ç³»

### ER å›¾

```mermaid
erDiagram
    NvrConfig ||--o{ ChannelConfig : "has"
    ChannelConfig ||--o{ ParkingSpace : "has"
    
    AutoScheduleRule ||--o{ TaskBatch : "creates"
    TaskBatch ||--o{ Task : "contains"
    Task ||--o{ Screenshot : "generates"
    Screenshot ||--o| OcrResult : "has"
    
    Screenshot ||--o{ ParkingChange : "triggers"
    ParkingSpace ||--o{ ParkingChange : "monitors"
    ChannelConfig ||--o{ ParkingChange : "belongs_to"
    
    Screenshot ||--o{ ParkingChangeSnapshot : "summarizes"
    ChannelConfig ||--o{ ParkingChangeSnapshot : "belongs_to"
    
    Task {
        int id PK
        int batch_id FK
        string date
        int start_ts
        int end_ts
        string rtsp_url
        string ip
        string channel
        string status
        string screenshot_path
        int retry_count
        datetime created_at
    }
    
    Screenshot {
        int id PK
        int task_id FK
        string file_path
        string yolo_status
        string yolo_last_error
        datetime created_at
    }
    
    ParkingChange {
        int id PK
        int screenshot_id FK
        int space_id FK
        int channel_config_id FK
        boolean prev_occupied
        boolean curr_occupied
        string change_type
        float detection_confidence
        datetime detected_at
    }
    
    ParkingChangeSnapshot {
        int id PK
        int screenshot_id FK
        int channel_config_id FK
        int change_count
        datetime detected_at
    }
    
    ChannelConfig {
        int id PK
        int nvr_config_id FK
        string channel_code
        string track_space
    }
    
    ParkingSpace {
        int id PK
        int channel_config_id FK
        string space_name
        int bbox_x1
        int bbox_y1
        int bbox_x2
        int bbox_y2
    }
```

### æ•°æ®æµè½¬

```
RTSPæµ â†’ æˆªå›¾æ–‡ä»¶ â†’ Screenshotè®°å½• â†’ Taskå…³è”
         â†“
    æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ (screenshots/æ—¥æœŸ/)
         â†“
    YOLOæ£€æµ‹ â†’ ParkingChangeè®°å½• â†’ ParkingChangeSnapshot
         â†“
    é€šè¿‡ /shots/ æˆ– /api/image_proxy è®¿é—®
         â†“
    å‰ç«¯å±•ç¤ºï¼ˆå›¾ç‰‡åˆ—è¡¨ã€è½¦ä½å˜åŒ–ï¼‰
```

---

## åå°ä»»åŠ¡æœºåˆ¶

### åå°ä»»åŠ¡æ¶æ„

```mermaid
graph TB
    subgraph "åº”ç”¨å¯åŠ¨ (Lifespan)"
        START[åº”ç”¨å¯åŠ¨]
        DB_INIT[æ•°æ®åº“è¡¨åˆ›å»º]
        YOLO_INIT[YOLOæ¨¡å‹é¢„åŠ è½½]
    end
    
    subgraph "åå°çº¿ç¨‹"
        SCHEDULE[å®šæ—¶è°ƒåº¦å™¨<br/>æ¯åˆ†é’Ÿæ£€æŸ¥è§„åˆ™]
        PENDING[å¾…è¿è¡Œæ£€æŸ¥å™¨<br/>æ¯5ç§’æ£€æŸ¥]
        RETRY[é‡è¯•æ£€æŸ¥å™¨<br/>æ¯å°æ—¶æ£€æŸ¥]
        YOLO_WORKER[è½¦ä½å˜åŒ–æ£€æµ‹å™¨<br/>æ¯5ç§’å¤„ç†æˆªå›¾]
    end
    
    subgraph "ä»»åŠ¡æ‰§è¡Œ"
        TASK_RUN[ä»»åŠ¡è¿è¡Œå™¨<br/>çº¿ç¨‹æ± æ‰§è¡Œ]
        YOLO_PROCESS[YOLOå¤„ç†å™¨<br/>å•çº¿ç¨‹å¤„ç†]
    end
    
    START --> DB_INIT
    DB_INIT --> YOLO_INIT
    YOLO_INIT --> SCHEDULE
    YOLO_INIT --> PENDING
    YOLO_INIT --> RETRY
    YOLO_INIT --> YOLO_WORKER
    
    SCHEDULE --> TASK_RUN
    PENDING --> TASK_RUN
    RETRY --> TASK_RUN
    YOLO_WORKER --> YOLO_PROCESS
```

### 1. å®šæ—¶è°ƒåº¦å™¨ (start_schedule_checker)

**åŠŸèƒ½**: æ£€æŸ¥è‡ªåŠ¨åˆ†é…è§„åˆ™ï¼Œåœ¨æŒ‡å®šæ—¶é—´è‡ªåŠ¨åˆ›å»ºå¹¶è¿è¡Œä»»åŠ¡

**æ‰§è¡Œé¢‘ç‡**: æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡

**ä½ç½®**: `app/main.py` (å‡½æ•° `check_and_execute_rules`)

**æµç¨‹**:
1. è·å–å½“å‰åŒ—äº¬æ—¶é—´
2. æŸ¥è¯¢æ‰€æœ‰å¯ç”¨çš„è§„åˆ™
3. æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦åŒ¹é…è§„åˆ™çš„ `trigger_time`
4. æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²æ‰§è¡Œè¿‡ï¼ˆé˜²æ­¢é‡å¤æ‰§è¡Œï¼‰
5. å¦‚æœåŒ¹é…ä¸”æœªæ‰§è¡Œï¼Œæ‰§è¡Œè§„åˆ™ï¼š
   - ç¡®å®šç›®æ ‡æ—¥æœŸï¼ˆuse_today æˆ– custom_dateï¼‰
   - è°ƒç”¨ä»»åŠ¡åˆ›å»ºå’Œè¿è¡ŒæœåŠ¡
   - æ›´æ–°è§„åˆ™æ‰§è¡Œä¿¡æ¯ï¼ˆlast_executed_at, execution_countï¼‰

### 2. å¾…è¿è¡Œä»»åŠ¡æ£€æŸ¥å™¨ (start_pending_runner)

**åŠŸèƒ½**: è‡ªåŠ¨æ£€æµ‹å¹¶æ‰§è¡Œå¾…è¿è¡Œçš„ä»»åŠ¡ç»„åˆ

**æ‰§è¡Œé¢‘ç‡**: æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡

**ä½ç½®**: `app/main.py` (å‡½æ•° `start_pending_runner`)

**æµç¨‹**:
1. æŸ¥è¯¢çŠ¶æ€ä¸º `pending` æˆ– `playing` ä¸”æ²¡æœ‰æˆªå›¾çš„ä»»åŠ¡
2. æŒ‰ (date, base_rtsp, channel) åˆ†ç»„
3. æ£€æŸ¥æ˜¯å¦å·²åœ¨è¿è¡Œä¸­ï¼ˆRUNNING_KEYSï¼‰
4. å¦‚æœä¸åœ¨è¿è¡Œä¸­ï¼Œå¯åŠ¨ä»»åŠ¡æ‰§è¡Œ
5. ä½¿ç”¨ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°ï¼ˆMAX_COMBO_CONCURRENCY=4ï¼‰

### 3. å¤±è´¥é‡è¯•æ£€æŸ¥å™¨ (start_failed_task_retry_checker)

**åŠŸèƒ½**: è‡ªåŠ¨é‡è¯•å¤±è´¥çš„ä»»åŠ¡

**æ‰§è¡Œé¢‘ç‡**: æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡

**ä½ç½®**: `app/main.py` (å‡½æ•° `check_and_retry_failed_tasks`)

**æµç¨‹**:
1. æŸ¥è¯¢éœ€è¦é‡è¯•çš„å¤±è´¥ä»»åŠ¡ï¼ˆretry_count < MAX_RETRY_COUNT=3ï¼‰
2. æ£€æŸ¥ `next_retry_at` æ˜¯å¦å·²åˆ°
3. å¦‚æœå·²åˆ°ï¼Œé‡æ–°è¿è¡Œä»»åŠ¡
4. æ›´æ–°é‡è¯•æ¬¡æ•°å’Œä¸‹æ¬¡é‡è¯•æ—¶é—´ï¼ˆå»¶è¿Ÿ1å°æ—¶ï¼‰

### 4. è½¦ä½å˜åŒ–æ£€æµ‹å™¨ (start_parking_change_detector)

**åŠŸèƒ½**: å¼‚æ­¥å¤„ç†æˆªå›¾çš„è½¦ä½å˜åŒ–æ£€æµ‹

**æ‰§è¡Œé¢‘ç‡**: æ¯5ç§’å¤„ç†ä¸€æ‰¹ï¼ˆbatch_size=10ï¼‰

**ä½ç½®**: `app/background/parking_change_worker.py`

**æµç¨‹**:
1. æŸ¥è¯¢ `yolo_status='pending'` çš„æˆªå›¾
2. å¯¹æ¯å¼ æˆªå›¾ï¼š
   - è·å–é€šé“é…ç½®å’Œè½¦ä½åæ ‡
   - å¯¹æ¯ä¸ªè½¦ä½åŒºåŸŸè¿›è¡ŒYOLOæ£€æµ‹
   - ä¸å†å²çŠ¶æ€å¯¹æ¯”ï¼Œåˆ¤æ–­å˜åŒ–ç±»å‹
   - è®°å½•åˆ° `parking_changes` è¡¨
   - å¦‚æœæœ‰å˜åŒ–ï¼Œç”Ÿæˆ `parking_change_snapshots` è®°å½•
   - ç»˜åˆ¶æ£€æµ‹åŒºåŸŸæ ‡è®°å›¾ï¼ˆ`_detected.jpg`ï¼‰
3. æ›´æ–°æˆªå›¾çŠ¶æ€ä¸º `done` æˆ– `failed`

**å…³é”®ç‰¹æ€§**:
- å•ä¾‹æ¨¡å¼ï¼šYOLOæ¨¡å‹å…¨å±€åªåŠ è½½ä¸€æ¬¡
- æ‰¹é‡å¤„ç†ï¼šæ¯æ¬¡å¤„ç†10å¼ æˆªå›¾
- æ—¶é—´é¡ºåºå¯¹æ¯”ï¼šä¸¥æ ¼æŒ‰æ—¶é—´é¡ºåºå¯¹æ¯”ï¼Œä¸å…è®¸è·¨æ—¶é—´æ®µ
- å¤šå¸§ç¡®è®¤ï¼šæ£€æŸ¥å‰2å¸§çŠ¶æ€ï¼Œå‡å°‘è¯¯åˆ¤

---

## API ç«¯ç‚¹è¯´æ˜

### ä»»åŠ¡ç®¡ç† API (`/api/tasks`)

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | æœåŠ¡å±‚æ–¹æ³• |
|------|------|------|-----------|
| `/create` | POST | åˆ›å»ºä»»åŠ¡ | `TaskService.ensure_tasks()` |
| `/available_dates` | GET | è·å–å¯ç”¨æ—¥æœŸ | `TaskService.get_available_dates()` |
| `/available_ips` | GET | è·å–å¯ç”¨IP | `TaskService.get_available_ips()` |
| `/available_channels` | GET | è·å–å¯ç”¨é€šé“ | `TaskService.get_available_channels()` |
| `/configs` | GET | è·å–ä»»åŠ¡é…ç½®åˆ—è¡¨ | `TaskService.get_task_configs()` |
| `/configs` | DELETE | åˆ é™¤ä»»åŠ¡é…ç½® | `TaskCleanupService.delete_tasks_by_config()` |
| `/configs/rerun` | POST | é‡æ–°è¿è¡Œé…ç½® | `TaskService.rerun_config()` |
| `/paged` | GET | åˆ†é¡µæŸ¥è¯¢ä»»åŠ¡ | `TaskService.get_tasks_paged()` |
| `/{task_id}` | DELETE | åˆ é™¤ä»»åŠ¡ | `TaskCleanupService.delete_task()` |
| `/{task_id}/rerun` | POST | é‡æ–°è¿è¡Œä»»åŠ¡ | `TaskService.rerun_task()` |
| `/run` | POST | è¿è¡ŒæŒ‡å®šä»»åŠ¡ | `TaskService.run_tasks()` |
| `/run_all` | POST | è¿è¡Œæ‰€æœ‰å¾…è¿è¡Œä»»åŠ¡ | `TaskService.run_all_tasks()` |

### å›¾ç‰‡ç®¡ç† API (`/api/images`)

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | æœåŠ¡å±‚æ–¹æ³• |
|------|------|------|-----------|
| `/` | GET | è·å–æ‰€æœ‰å›¾ç‰‡ | `ImageService.list_images()` |
| `/{date}` | GET | æŒ‰æ—¥æœŸè·å–å›¾ç‰‡ | `ImageService.list_images()` |
| `/available_dates` | GET | è·å–å¯ç”¨æ—¥æœŸ | `ImageService.get_available_dates()` |
| `/task/{task_id}/ocr` | GET | è·å–ä»»åŠ¡çš„OCRç»“æœ | `ImageService.get_task_ocr()` |

**æœç´¢å‚æ•°**:
- `name__eq`: ç²¾å‡†æœç´¢å›¾ç‰‡åç§°
- `name__like`: æ¨¡ç³Šæœç´¢å›¾ç‰‡åç§°
- `task_ip`, `task_ip__like`: IPæœç´¢
- `task_channel`, `task_channel__like`: é€šé“æœç´¢
- `status_label`, `status_label__in`: çŠ¶æ€æ ‡ç­¾æœç´¢
- `missing`: æ˜¯å¦ç¼ºå¤±

### è‡ªåŠ¨è°ƒåº¦ API (`/api/auto-schedule`)

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | æœåŠ¡å±‚æ–¹æ³• |
|------|------|------|-----------|
| `/rules` | GET | è·å–æ‰€æœ‰è§„åˆ™ | `AutoScheduleService.get_all_rules()` |
| `/rules` | POST | åˆ›å»ºè§„åˆ™ | `AutoScheduleService.create_rule()` |
| `/rules/{rule_id}` | PATCH | æ›´æ–°è§„åˆ™ | `AutoScheduleService.update_rule()` |
| `/rules/{rule_id}` | DELETE | åˆ é™¤è§„åˆ™ | `AutoScheduleService.delete_rule()` |

### è½¦ä½å˜åŒ– API (`/api/parking_changes`)

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | æœåŠ¡å±‚æ–¹æ³• |
|------|------|------|-----------|
| `/` | GET | åˆ†é¡µè·å–å˜åŒ–å¿«ç…§åˆ—è¡¨ | `ParkingChangeService.list_snapshots()` |
| `/grouped` | GET | æŒ‰é€šé“åˆ†ç»„è·å–å˜åŒ–å¿«ç…§ | `ParkingChangeService.list_snapshots_grouped_by_channel()` |
| `/analysis/{channel_config_id}` | GET | è·å–é€šé“è¯¦ç»†åˆ†ææŠ¥å‘Š | `ParkingChangeService.get_channel_analysis_report()` |
| `/{snapshot_id}` | GET | è·å–å¿«ç…§è¯¦æƒ… | `ParkingChangeService.get_snapshot_detail()` |

**æœç´¢å‚æ•°**:
- `date`: ä»»åŠ¡æ—¥æœŸ
- `ip`, `ip__like`: IPæœç´¢
- `channel`, `channel__like`: é€šé“æœç´¢
- `parking_name`: è½¦åœºåç§°
- `space_name`: è½¦ä½ç¼–å·
- `change_type`: å˜åŒ–ç±»å‹ï¼ˆarrive/leaveï¼‰

### å·¥å…·ç±» API

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | æœåŠ¡å±‚æ–¹æ³• |
|------|------|------|-----------|
| `/healthz` | GET | å¥åº·æ£€æŸ¥ | `UtilsService.get_health_status()` |
| `/api/hls/start` | GET | å¯åŠ¨HLSæµ | `UtilsService.start_hls_stream()` |
| `/api/image_proxy` | GET | å›¾ç‰‡ä»£ç† | `UtilsService.proxy_image()` |
| `/` | GET | é¦–é¡µ | `UtilsService.get_index_page()` |
| `/api/admin/clear_all` | POST | æ¸…ç©ºæ‰€æœ‰æ•°æ® | `UtilsService.clear_all_data()` |
| `/api/admin/redeploy` | POST | é‡æ–°éƒ¨ç½²ç³»ç»Ÿ | `UtilsService.redeploy_system()` |

---

## å‰ç«¯æ¶æ„

### å‰ç«¯æ–‡ä»¶ç»“æ„

```
app/static/
â”œâ”€â”€ index.html          # ä¸»é¡µé¢ï¼ˆå•é¡µåº”ç”¨ï¼‰
â”œâ”€â”€ css/
â”‚   â””â”€â”€ styles.css     # å…¨å±€æ ·å¼
â””â”€â”€ js/
    â”œâ”€â”€ api.js         # APIè°ƒç”¨å°è£…
    â”œâ”€â”€ utils.js       # å·¥å…·å‡½æ•°
    â”œâ”€â”€ main.js        # ä¸»é€»è¾‘ã€è§†å›¾åˆ‡æ¢
    â”œâ”€â”€ dashboard.js  # ä»ªè¡¨ç›˜ã€ä»»åŠ¡åˆ›å»º
    â”œâ”€â”€ tasks.js       # ä»»åŠ¡åˆ—è¡¨ç®¡ç†
    â”œâ”€â”€ images.js      # å›¾ç‰‡åˆ—è¡¨ã€é¢„è§ˆ
    â”œâ”€â”€ parking-changes.js  # è½¦ä½å˜åŒ–é¡µé¢
    â”œâ”€â”€ nvr-config.js  # NVRé…ç½®ç®¡ç†
    â””â”€â”€ libs/          # ç¬¬ä¸‰æ–¹åº“
        â”œâ”€â”€ hls.min.js
        â”œâ”€â”€ flatpickr.min.js
        â””â”€â”€ flatpickr.min.css
```

### å‰ç«¯è§†å›¾

| è§†å›¾ID | è§†å›¾åç§° | ä¸»è¦åŠŸèƒ½ | JSæ–‡ä»¶ |
|--------|---------|---------|--------|
| `view-dashboard` | ä»ªè¡¨ç›˜ | ä»»åŠ¡åˆ›å»ºã€RTSPé…ç½® | `dashboard.js` |
| `view-tasks` | ä»»åŠ¡åˆ—è¡¨ | ä»»åŠ¡æŸ¥è¯¢ã€ç®¡ç† | `tasks.js` |
| `view-images` | å›¾ç‰‡åˆ—è¡¨ | å›¾ç‰‡æŸ¥è¯¢ã€é¢„è§ˆ | `images.js` |
| `view-parking-changes` | è½¦ä½å˜åŒ– | å˜åŒ–æŸ¥è¯¢ã€å¯¹æ¯”åˆ†æ | `parking-changes.js` |
| `view-nvr-config` | NVRé…ç½® | é…ç½®ç®¡ç†ã€åæ ‡è®¾ç½® | `nvr-config.js` |

### å‰ç«¯ç‰¹æ€§

1. **å•é¡µåº”ç”¨ (SPA)**: æ‰€æœ‰è§†å›¾åœ¨ä¸€ä¸ªHTMLé¡µé¢ä¸­ï¼Œé€šè¿‡JavaScriptåˆ‡æ¢
2. **å…¨å±€å›¾ç‰‡é¢„è§ˆ**: æ”¯æŒå•å›¾å’Œå¤šå›¾å¯¹æ¯”é¢„è§ˆï¼ˆæ¨¡æ€æ¡†ï¼‰
3. **åŠ¨æ€ç­›é€‰**: æ”¯æŒå¤šæ¡ä»¶ç»„åˆæœç´¢
4. **å®æ—¶æ›´æ–°**: æ”¯æŒå®šæ—¶åˆ·æ–°æ•°æ®
5. **å“åº”å¼è®¾è®¡**: é€‚é…ä¸åŒå±å¹•å°ºå¯¸

---

## å…³é”®é€»è¾‘è¯´æ˜

### 1. ä»»åŠ¡çŠ¶æ€æµè½¬

```
pending â†’ playing â†’ completed
                â†“
             failed â†’ (retry) â†’ playing â†’ completed/failed
```

**çŠ¶æ€è¯´æ˜**:
- `pending`: ä»»åŠ¡å·²åˆ›å»ºï¼Œç­‰å¾…æ‰§è¡Œ
- `playing`: ä»»åŠ¡æ­£åœ¨æ‰§è¡Œä¸­
- `completed`: ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œå·²ç”Ÿæˆæˆªå›¾
- `failed`: ä»»åŠ¡æ‰§è¡Œå¤±è´¥

**çŠ¶æ€åè°ƒ**: `TaskRepository.reconcile_task_status()` å®šæœŸæ£€æŸ¥å¹¶ä¿®æ­£çŠ¶æ€ä¸ä¸€è‡´çš„ä»»åŠ¡

### 2. ä¸€ä»»åŠ¡ä¸€å›¾åŸåˆ™

**è®¾è®¡åŸåˆ™**: æ¯ä¸ªä»»åŠ¡åªä¿ç•™ä¸€å¼ æœ€æ–°æˆªå›¾

**å®ç°æ–¹å¼**:
- æˆªå›¾æ—¶æ£€æŸ¥æ˜¯å¦å·²æœ‰æˆªå›¾è®°å½•
- å¦‚æœå­˜åœ¨ï¼Œæ›´æ–°ç°æœ‰è®°å½•çš„æ–‡ä»¶è·¯å¾„
- å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°è®°å½•
- ä¿è¯ `tasks` å’Œ `screenshots` çš„ä¸€å¯¹ä¸€å…³ç³»

### 3. å¹¶å‘æ§åˆ¶æœºåˆ¶

**å…¨å±€å¹¶å‘é™åˆ¶**: `MAX_COMBO_CONCURRENCY = 4`

**å®ç°æ–¹å¼**:
- ä½¿ç”¨ `threading.Semaphore` æ§åˆ¶å¹¶å‘æ•°
- æ¯ä¸ªä»»åŠ¡ç»„åˆæ‰§è¡Œå‰è·å–ä¿¡å·é‡
- æ‰§è¡Œå®Œæˆåé‡Šæ”¾ä¿¡å·é‡
- é˜²æ­¢è¿‡å¤šå¹¶å‘å¯¼è‡´èµ„æºè€—å°½

### 4. å›¾ç‰‡URLæ„å»ºç­–ç•¥

**ç­–ç•¥1**: ç›¸å¯¹è·¯å¾„åœ¨æˆªå›¾ç›®å½•ä¸‹
- URL: `/shots/{ç›¸å¯¹è·¯å¾„}`
- é€šè¿‡ FastAPI StaticFiles ç›´æ¥è®¿é—®

**ç­–ç•¥2**: ç»å¯¹è·¯å¾„æˆ–ä¸åœ¨æˆªå›¾ç›®å½•ä¸‹
- URL: `/api/image_proxy?path={è·¯å¾„}`
- é€šè¿‡ä»£ç†ç«¯ç‚¹è®¿é—®ï¼Œæ”¯æŒä»»æ„è·¯å¾„

**ç­–ç•¥3**: ä¼˜å…ˆä½¿ç”¨æ£€æµ‹æ ‡è®°å›¾
- å¦‚æœå­˜åœ¨ `_detected.jpg`ï¼Œä¼˜å…ˆè¿”å›è¯¥URL
- å¦‚æœä¸å­˜åœ¨ï¼Œå›é€€åˆ°åŸå§‹å›¾ç‰‡

### 5. è‡ªåŠ¨è°ƒåº¦è§„åˆ™éªŒè¯

**éªŒè¯é¡¹**:
1. æ—¥æœŸé€‰æ‹©: `use_today` å’Œ `custom_date` äº’æ–¥
2. è§¦å‘æ—¶é—´: æ ¼å¼ä¸º `HH:mm`ï¼ŒèŒƒå›´ 00:00-23:59
3. RTSPåœ°å€: å¿…é¡»ä»¥ `rtsp://` å¼€å¤´
4. é€šé“æ ¼å¼: å¿…é¡»ä¸º `c1`, `c2`, `c3` ç­‰æ ¼å¼
5. é—´éš”åˆ†é’Ÿ: èŒƒå›´ 1-1440 åˆ†é’Ÿ

**è§„åˆ™åç§°ç”Ÿæˆ**: å¦‚æœæœªæä¾›åç§°ï¼Œè‡ªåŠ¨ç”Ÿæˆ `{ip}_{channel}_{trigger_time}`

### 6. HLS æµè½¬æ¢æµç¨‹

```
RTSPæµ â†’ FFmpegæ¢æµ‹ â†’ å¯åŠ¨FFmpegè¿›ç¨‹ â†’ ç­‰å¾…m3u8ç”Ÿæˆ â†’ è¿”å›m3u8 URL
```

**å…³é”®æ­¥éª¤**:
1. **RTSPæ¢æµ‹**: ä½¿ç”¨ `probe_rtsp()` éªŒè¯æµå¯ç”¨æ€§
2. **è¿›ç¨‹å¯åŠ¨**: ä½¿ç”¨ `start_hls()` å¯åŠ¨ FFmpeg è¿›ç¨‹
3. **æ–‡ä»¶ç­‰å¾…**: è½®è¯¢ç­‰å¾… `index.m3u8` æ–‡ä»¶ç”Ÿæˆï¼ˆæœ€å¤š20ç§’ï¼‰
4. **è¿›ç¨‹ç®¡ç†**: å°†è¿›ç¨‹ä¿å­˜åœ¨ `HLS_PROCS` å­—å…¸ä¸­
5. **é”™è¯¯å¤„ç†**: å¦‚æœè¶…æ—¶æˆ–è¿›ç¨‹é€€å‡ºï¼Œè¿”å›é”™è¯¯ä¿¡æ¯

### 7. è½¦ä½å˜åŒ–æ£€æµ‹é€»è¾‘

**æ£€æµ‹ç­–ç•¥**:
1. **ä¼˜å…ˆæ–¹æ¡ˆ**: è½¦ä½åŒºåŸŸç›´æ¥æ£€æµ‹ï¼ˆåŒºåŸŸ >= 16x16ï¼‰
2. **å›é€€æ–¹æ¡ˆ**: è·Ÿè¸ªåŒºåŸŸ + äº¤é›†è®¡ç®—ï¼ˆåŒºåŸŸ < 16x16ï¼‰

**å¯¹æ¯”é€»è¾‘**:
1. **ä¸¥æ ¼æŒ‰æ—¶é—´é¡ºåº**: å›¾1â†’å›¾2ï¼Œå›¾2â†’å›¾3...
2. **æ—¶é—´é—´éš”æ£€æŸ¥**: æœ€å¤§å…è®¸15åˆ†é’Ÿï¼ˆæˆªå›¾é—´éš”10åˆ†é’Ÿï¼‰
3. **å¤šå¸§ç¡®è®¤**: æ£€æŸ¥å‰2å¸§çŠ¶æ€ï¼Œå‡å°‘è¯¯åˆ¤

**å˜åŒ–ç±»å‹**:
- `arrive`: æ— è½¦ â†’ æœ‰è½¦ï¼ˆè¿›è½¦ï¼‰
- `leave`: æœ‰è½¦ â†’ æ— è½¦ï¼ˆç¦»å¼€ï¼‰
- `None`: æ— å˜åŒ–æˆ–ç¬¬ä¸€å¼ å›¾

---

## æ€§èƒ½ä¼˜åŒ–è¦ç‚¹

### 1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

- **ç´¢å¼•**: `date`, `ip`, `channel` å­—æ®µå»ºç«‹ç´¢å¼•
- **æ‰¹é‡æ“ä½œ**: ä½¿ç”¨æ‰¹é‡æ’å…¥å’Œæ›´æ–°
- **æŸ¥è¯¢ä¼˜åŒ–**: ä½¿ç”¨ JOIN å‡å°‘æŸ¥è¯¢æ¬¡æ•°
- **åˆ†é¡µ**: æ‰€æœ‰åˆ—è¡¨æŸ¥è¯¢æ”¯æŒåˆ†é¡µ
- **æ—¶é—´åºåˆ—æŸ¥è¯¢**: ä½¿ç”¨æ—¶é—´å­—æ®µè€ŒéIDè¿›è¡Œæ’åºå’Œè¿‡æ»¤

### 2. å¹¶å‘æ§åˆ¶

- **ä¿¡å·é‡**: é™åˆ¶ä»»åŠ¡ç»„åˆå¹¶å‘æ•°ï¼ˆMAX_COMBO_CONCURRENCY=4ï¼‰
- **çº¿ç¨‹æ± **: ä½¿ç”¨ ThreadPoolExecutor ç®¡ç†çº¿ç¨‹
- **è¿›ç¨‹ç®¡ç†**: HLS è¿›ç¨‹å­—å…¸ç®¡ç†ï¼Œé¿å…è¿›ç¨‹æ³„æ¼
- **å•ä¾‹æ¨¡å¼**: YOLOæ¨¡å‹å…¨å±€åªåŠ è½½ä¸€æ¬¡

### 3. æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–

- **é™æ€æ–‡ä»¶**: ä½¿ç”¨ FastAPI StaticFiles ç›´æ¥æœåŠ¡
- **è·¯å¾„ç¼“å­˜**: ç›¸å¯¹è·¯å¾„è®¡ç®—ç¼“å­˜
- **æ‰¹é‡æ“ä½œ**: æ–‡ä»¶åˆ é™¤æ‰¹é‡æ‰§è¡Œ
- **ä¸´æ—¶æ–‡ä»¶**: YOLOæ£€æµ‹ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ï¼Œæ£€æµ‹åç«‹å³æ¸…ç†

### 4. å†…å­˜ä¼˜åŒ–

- **æ¨¡å‹å•ä¾‹**: YOLOæ¨¡å‹å…¨å±€å•ä¾‹ï¼Œé¿å…é‡å¤åŠ è½½
- **æ‰¹é‡å¤„ç†**: æˆªå›¾æ‰¹é‡å¤„ç†ï¼Œé¿å…å†…å­˜ç§¯ç´¯
- **åŠæ—¶é‡Šæ”¾**: æ£€æµ‹å®ŒæˆååŠæ—¶é‡Šæ”¾èµ„æº

---

## å®‰å…¨è€ƒè™‘

### 1. SQLæ³¨å…¥é˜²æŠ¤

- **å‚æ•°åŒ–æŸ¥è¯¢**: æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢ä½¿ç”¨å‚æ•°åŒ–
- **è¾“å…¥éªŒè¯**: æœåŠ¡å±‚éªŒè¯æ‰€æœ‰è¾“å…¥å‚æ•°
- **ç±»å‹æ£€æŸ¥**: ä½¿ç”¨ Pydantic æ¨¡å‹éªŒè¯

### 2. æ–‡ä»¶è®¿é—®å®‰å…¨

- **è·¯å¾„éªŒè¯**: éªŒè¯æ–‡ä»¶è·¯å¾„ï¼Œé˜²æ­¢ç›®å½•éå†
- **æ–‡ä»¶å­˜åœ¨æ£€æŸ¥**: è®¿é—®å‰æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- **æƒé™æ§åˆ¶**: åªå…è®¸è®¿é—®æŒ‡å®šç›®å½•ä¸‹çš„æ–‡ä»¶

### 3. èµ„æºé™åˆ¶

- **å¹¶å‘é™åˆ¶**: é™åˆ¶åŒæ—¶è¿è¡Œçš„ä»»åŠ¡æ•°
- **è¶…æ—¶æ§åˆ¶**: HLS å¯åŠ¨è®¾ç½®è¶…æ—¶æ—¶é—´
- **èµ„æºæ¸…ç†**: åå°ä»»åŠ¡å¼‚å¸¸æ—¶æ¸…ç†èµ„æº
- **é‡è¯•é™åˆ¶**: å¤±è´¥ä»»åŠ¡æœ€å¤šé‡è¯•3æ¬¡

---

## æ‰©å±•æ€§è®¾è®¡

### 1. æ¨¡å—åŒ–è®¾è®¡

- **åˆ†å±‚æ¶æ„**: è·¯ç”±ã€æœåŠ¡ã€ä»“åº“åˆ†ç¦»
- **ä¾èµ–æ³¨å…¥**: ä½¿ç”¨ FastAPI Depends æ³¨å…¥ä¾èµ–
- **æ¥å£æŠ½è±¡**: Repository Pattern ä¾¿äºæ›¿æ¢å®ç°

### 2. å¯æ‰©å±•ç‚¹

- **æ–°è·¯ç”±**: æ·»åŠ æ–°çš„è·¯ç”±æ¨¡å—ï¼Œæ³¨å†Œåˆ° main.py
- **æ–°æœåŠ¡**: åœ¨ services ç›®å½•æ·»åŠ æ–°æœåŠ¡
- **æ–°ä»“åº“**: åœ¨ repositories ç›®å½•æ·»åŠ æ–°ä»“åº“
- **æ–°æ¨¡å‹**: åœ¨ models.py æ·»åŠ æ–°æ¨¡å‹
- **æ–°åå°ä»»åŠ¡**: åœ¨ background ç›®å½•æ·»åŠ æ–°Worker

### 3. é…ç½®åŒ–

- **ç¯å¢ƒå˜é‡**: æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡é…ç½®
- **å¸¸é‡é…ç½®**: æ ¸å¿ƒå¸¸é‡é›†ä¸­åœ¨ constants.py
- **è·¯å¾„é…ç½®**: æ‰€æœ‰è·¯å¾„é…ç½®é›†ä¸­åœ¨ config.py
- **YOLOå‚æ•°**: æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡é…ç½®YOLOå‚æ•°

---

## æµ‹è¯•æ¶æ„

### æµ‹è¯•åˆ†å±‚

```
é›†æˆæµ‹è¯• (APIå±‚)
    â†“
åŠŸèƒ½æµ‹è¯• (Serviceå±‚)
    â†“
å•å…ƒæµ‹è¯• (Repositoryå±‚)
```

### æµ‹è¯•è¦†ç›–

| æµ‹è¯•æ–‡ä»¶ | æµ‹è¯•ç±»å‹ | è¦†ç›–æ¨¡å— |
|---------|---------|---------|
| `test_task_repository.py` | å•å…ƒæµ‹è¯• | TaskRepository |
| `test_task_api_integration.py` | é›†æˆæµ‹è¯• | ä»»åŠ¡ç®¡ç†API |
| `test_image_api_integration.py` | é›†æˆæµ‹è¯• | å›¾ç‰‡ç®¡ç†API |
| `test_auto_schedule_api_integration.py` | é›†æˆæµ‹è¯• | è‡ªåŠ¨è°ƒåº¦API |
| `test_utils_api_integration.py` | é›†æˆæµ‹è¯• | å·¥å…·ç±»API |

**æµ‹è¯•ç»“æœ**: æ‰€æœ‰æµ‹è¯•é€šè¿‡ç‡ 100% âœ…

---

## é…ç½®ä¸å¸¸é‡

### æ ¸å¿ƒé…ç½® (`app/core/config.py`)

| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|--------|
| `SCREENSHOT_BASE` | æˆªå›¾å­˜å‚¨ç›®å½• | `PROJECT_ROOT/screenshots` |
| `HLS_BASE` | HLSè¾“å‡ºç›®å½• | `PROJECT_ROOT/hls` |
| `STATIC_DIR` | é™æ€æ–‡ä»¶ç›®å½• | `app/static` |
| `MAX_COMBO_CONCURRENCY` | æœ€å¤§å¹¶å‘ç»„åˆæ•° | 4 |
| `HLS_PROCS` | HLSè¿›ç¨‹å­—å…¸ | `{}` |
| `TASK_STORE` | ä»»åŠ¡å­˜å‚¨å­—å…¸ | `{}` |
| `RUNNING_KEYS` | è¿è¡Œä¸­ä»»åŠ¡é”®é›†åˆ | `set()` |

### å¸¸é‡å®šä¹‰ (`app/core/constants.py`)

| å¸¸é‡ | è¯´æ˜ | å€¼ |
|------|------|-----|
| `DEFAULT_PAGE_SIZE` | é»˜è®¤åˆ†é¡µå¤§å° | 20 |
| `MIN_PAGE_SIZE` | æœ€å°åˆ†é¡µå¤§å° | 10 |
| `MAX_PAGE_SIZE` | æœ€å¤§åˆ†é¡µå¤§å° | 50 |
| `MAX_RETRY_COUNT` | æœ€å¤§é‡è¯•æ¬¡æ•° | 3 |
| `TASKS_PREFIX` | ä»»åŠ¡APIå‰ç¼€ | `/api/tasks` |

### YOLOé…ç½® (ç¯å¢ƒå˜é‡)

| ç¯å¢ƒå˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ |
|---------|------|--------|
| `YOLO_MODEL_NAME` | æ¨¡å‹åç§° | `yolov8n.pt` |
| `YOLO_CUSTOM_MODEL_PATH` | è‡ªå®šä¹‰æ¨¡å‹è·¯å¾„ | - |
| `YOLO_CONF_THRESHOLD` | ç½®ä¿¡åº¦é˜ˆå€¼ | `0.25` |
| `YOLO_MIN_REGION_SIZE` | æœ€å°åŒºåŸŸå°ºå¯¸ | `16` |
| `YOLO_REGION_PADDING` | åŒºåŸŸpadding | `10` |

---

## ä¾èµ–å…³ç³»å›¾

```mermaid
graph TD
    subgraph "å¤–éƒ¨ä¾èµ–"
        FASTAPI[FastAPI]
        SQLALCHEMY[SQLAlchemy]
        CV2[OpenCV]
        FFMPEG[FFmpeg]
        YOLO[Ultralytics YOLOv8]
    end
    
    subgraph "åº”ç”¨æ¨¡å—"
        MAIN[main.py]
        ROUTERS[Routers]
        SERVICES[Services]
        REPOS[Repositories]
        MODELS[Models]
    end
    
    subgraph "å·¥å…·æ¨¡å—"
        SEGMENT[segment_generator]
        SCREENSHOT[screenshot]
        STREAM_CHECK[stream_check]
        STREAM_HLS[stream_hls]
        YOLO_DET[yolo_detector]
    end
    
    subgraph "åå°ä»»åŠ¡"
        BG_SCHEDULE[å®šæ—¶è°ƒåº¦å™¨]
        BG_PENDING[å¾…è¿è¡Œæ£€æŸ¥å™¨]
        BG_RETRY[é‡è¯•æ£€æŸ¥å™¨]
        BG_YOLO[è½¦ä½å˜åŒ–æ£€æµ‹å™¨]
    end
    
    MAIN --> FASTAPI
    ROUTERS --> SERVICES
    SERVICES --> REPOS
    REPOS --> MODELS
    MODELS --> SQLALCHEMY
    
    SERVICES --> SEGMENT
    SERVICES --> SCREENSHOT
    SERVICES --> STREAM_CHECK
    SERVICES --> STREAM_HLS
    SERVICES --> YOLO_DET
    
    SCREENSHOT --> CV2
    STREAM_HLS --> FFMPEG
    YOLO_DET --> YOLO
    
    BG_SCHEDULE --> SERVICES
    BG_PENDING --> SERVICES
    BG_RETRY --> SERVICES
    BG_YOLO --> YOLO_DET
    BG_YOLO --> REPOS
```

---

## æ•°æ®æµè½¬æ€»è§ˆ

### å®Œæ•´æ•°æ®æµ

```mermaid
graph LR
    A[RTSPæµæº] --> B[ä»»åŠ¡åˆ›å»º]
    B --> C[ä»»åŠ¡æ‰§è¡Œ]
    C --> D[æˆªå›¾ä¿å­˜]
    D --> E[æ–‡ä»¶ç³»ç»Ÿ]
    D --> F[æ•°æ®åº“è®°å½•]
    F --> G[YOLOæ£€æµ‹]
    G --> H[è½¦ä½å˜åŒ–è®°å½•]
    H --> I[å‰ç«¯å±•ç¤º]
    E --> I
```

### å…³é”®æ•°æ®è¡¨

1. **ä»»åŠ¡ç®¡ç†**: `task_batches` â†’ `tasks` â†’ `screenshots`
2. **é…ç½®ç®¡ç†**: `nvr_configs` â†’ `channel_configs` â†’ `parking_spaces`
3. **å˜åŒ–æ£€æµ‹**: `screenshots` â†’ `parking_changes` â†’ `parking_change_snapshots`

---

## æ€»ç»“

### æ¶æ„ä¼˜åŠ¿

1. **æ¸…æ™°çš„åˆ†å±‚**: è·¯ç”±ã€æœåŠ¡ã€ä»“åº“èŒè´£æ˜ç¡®
2. **æ˜“äºæµ‹è¯•**: æ¯å±‚å¯ç‹¬ç«‹æµ‹è¯•
3. **æ˜“äºç»´æŠ¤**: ä»£ç ç»„ç»‡æ¸…æ™°ï¼Œæ˜“äºå®šä½é—®é¢˜
4. **æ˜“äºæ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ·»åŠ åŠŸèƒ½ä¸å½±å“ç°æœ‰ä»£ç 
5. **ç¬¦åˆæœ€ä½³å®è·µ**: éµå¾ª FastAPI å’Œ Python æœ€ä½³å®è·µ
6. **é«˜æ€§èƒ½**: å¹¶å‘æ§åˆ¶ã€æ‰¹é‡æ“ä½œã€ç´¢å¼•ä¼˜åŒ–

### ç³»ç»Ÿç‰¹æ€§

- âœ… **è‡ªåŠ¨åŒ–**: è‡ªåŠ¨è°ƒåº¦ã€è‡ªåŠ¨æ‰§è¡Œã€è‡ªåŠ¨é‡è¯•
- âœ… **æ™ºèƒ½åŒ–**: YOLOè½¦è¾†æ£€æµ‹ã€å¤šå¸§ç¡®è®¤ã€æ—¶é—´åºåˆ—åˆ†æ
- âœ… **å¯è§†åŒ–**: æ£€æµ‹åŒºåŸŸæ ‡è®°ã€å¯¹æ¯”åˆ†ææŠ¥å‘Š
- âœ… **å¯æ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½
- âœ… **é«˜æ€§èƒ½**: å¹¶å‘æ§åˆ¶ã€æ‰¹é‡å¤„ç†ã€æŸ¥è¯¢ä¼˜åŒ–

### é‡æ„æˆæœ

- âœ… **ä»£ç åˆ†ç¦»**: 2400+ è¡Œä»£ç åˆ†ç¦»åˆ°å¤šä¸ªæ¨¡å—
- âœ… **æµ‹è¯•è¦†ç›–**: 34ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œ100% é€šè¿‡ç‡
- âœ… **APIå…¼å®¹**: ä¿æŒæ‰€æœ‰ API æ¥å£å‘åå…¼å®¹
- âœ… **æ–‡æ¡£å®Œå–„**: å®Œæ•´çš„ä»£ç æ–‡æ¡£å’Œæµ‹è¯•æ–‡æ¡£
- âœ… **åŠŸèƒ½å¢å¼º**: æ·»åŠ è½¦ä½å˜åŒ–æ£€æµ‹ã€NVRé…ç½®ç®¡ç†

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0.0  
**æœ€åæ›´æ–°**: 2025-12-20  
**ç»´æŠ¤è€…**: QJZH Team
