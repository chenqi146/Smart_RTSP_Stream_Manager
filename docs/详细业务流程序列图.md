# Smart RTSP Stream Manager - è¯¦ç»†ä¸šåŠ¡æµç¨‹åºåˆ—å›¾

> æœ¬æ–‡æ¡£æä¾›å…³é”®ä¸šåŠ¡æµç¨‹çš„è¯¦ç»†åºåˆ—å›¾ï¼Œå±•ç¤ºå„ç»„ä»¶ä¹‹é—´çš„äº¤äº’æ—¶åºã€‚

## ğŸ“‹ ç›®å½•

1. [ä»»åŠ¡åˆ›å»ºä¸æ‰§è¡Œå®Œæ•´æµç¨‹](#ä»»åŠ¡åˆ›å»ºä¸æ‰§è¡Œå®Œæ•´æµç¨‹)
2. [å›¾ç‰‡æŸ¥è¯¢ä¸å±•ç¤ºæµç¨‹](#å›¾ç‰‡æŸ¥è¯¢ä¸å±•ç¤ºæµç¨‹)
3. [è‡ªåŠ¨è°ƒåº¦è§„åˆ™æ‰§è¡Œæµç¨‹](#è‡ªåŠ¨è°ƒåº¦è§„åˆ™æ‰§è¡Œæµç¨‹)
4. [HLSæµè½¬æ¢æµç¨‹](#hlsæµè½¬æ¢æµç¨‹)
5. [ä»»åŠ¡é‡è¯•æµç¨‹](#ä»»åŠ¡é‡è¯•æµç¨‹)

---

## ä»»åŠ¡åˆ›å»ºä¸æ‰§è¡Œå®Œæ•´æµç¨‹

### å®Œæ•´åºåˆ—å›¾

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Router as tasks.py
    participant Service as TaskService
    participant Repo as TaskRepository
    participant Cleanup as TaskCleanupService
    participant SegmentGen as segment_generator
    participant RTSPCheck as stream_check
    participant DB as Database
    participant BG as Background Runner
    participant ThreadPool as ThreadPoolExecutor
    participant Capture as capture_frame
    participant FS as File System
    
    Note over Client,FS: ===== é˜¶æ®µ1: ä»»åŠ¡åˆ›å»º =====
    
    Client->>Router: POST /api/tasks/create<br/>{date, base_rtsp, channel, interval_minutes}
    Router->>Service: ensure_tasks(req)
    
    Service->>SegmentGen: build_segment_tasks(date, base_rtsp, channel, interval_minutes)
    SegmentGen-->>Service: segments[144ä¸ªä»»åŠ¡æ®µ]
    
    Service->>RTSPCheck: check_rtsp(first_segment.rtsp_url)
    RTSPCheck-->>Service: (ok=True/False, error)
    
    Service->>Repo: get_tasks_by_filters(date, base_rtsp, channel)
    Repo->>DB: SELECT * FROM tasks WHERE...
    DB-->>Repo: existing_tasks[]
    Repo-->>Service: existing_tasks[]
    
    alt ä»»åŠ¡å·²å­˜åœ¨
        Service->>Cleanup: delete_tasks_by_config(date, base_rtsp, channel)
        Cleanup->>Repo: get_tasks_by_filters()
        Repo->>DB: SELECT tasks
        DB-->>Repo: task_ids[]
        Repo-->>Cleanup: task_ids[]
        
        Cleanup->>DB: DELETE FROM screenshots WHERE task_id IN (...)
        Cleanup->>DB: DELETE FROM tasks WHERE id IN (...)
        Cleanup->>FS: åˆ é™¤æˆªå›¾æ–‡ä»¶
        Cleanup-->>Service: æ¸…ç†å®Œæˆ
    end
    
    Service->>Repo: create_batch(segments)
    Repo->>DB: INSERT INTO tasks (...) VALUES (...)
    DB-->>Repo: task_ids[]
    Repo-->>Service: task_ids[]
    
    Service->>Service: è‡ªåŠ¨å¯åŠ¨è¿è¡Œä»»åŠ¡
    Service-->>Router: TaskCreateResponse{segments: 144}
    Router-->>Client: 201 Created
    
    Note over Client,FS: ===== é˜¶æ®µ2: åå°è‡ªåŠ¨æ‰§è¡Œ =====
    
    BG->>Repo: get_pending_or_playing_tasks()
    Repo->>DB: SELECT * FROM tasks<br/>WHERE status IN ('pending','playing')<br/>AND screenshot_path IS NULL
    DB-->>Repo: pending_tasks[]
    Repo-->>BG: pending_tasks[]
    
    BG->>BG: æŒ‰(date, base_rtsp, channel)åˆ†ç»„
    BG->>BG: æ£€æŸ¥RUNNING_KEYSï¼Œè·å–ä¿¡å·é‡
    
    BG->>ThreadPool: æäº¤ä»»åŠ¡ç»„åˆæ‰§è¡Œ
    
    ThreadPool->>Service: æ‰§è¡Œä»»åŠ¡ç»„åˆ
    Service->>Repo: update_status_batch('playing')
    Repo->>DB: UPDATE tasks SET status='playing'<br/>WHERE date=? AND base_rtsp=? AND channel=?
    
    par å¹¶è¡Œå¤„ç†å¤šä¸ªä»»åŠ¡æ®µ
        ThreadPool->>Capture: capture_frame(rtsp_url, output_path)
        Capture->>RTSP: è¿æ¥RTSPæµ
        RTSP-->>Capture: è§†é¢‘å¸§æ•°æ®
        Capture->>Capture: è·³è¿‡warmup_frames(20å¸§)
        Capture->>FS: cv2.imwrite(output_path, frame)
        FS-->>Capture: ä¿å­˜æˆåŠŸ
        
        Capture->>DB: INSERT INTO screenshots<br/>(task_id, file_path)<br/>ON DUPLICATE UPDATE file_path=?
        DB-->>Capture: screenshot_id
        
        Capture-->>ThreadPool: æˆªå›¾æˆåŠŸ
        ThreadPool->>Repo: update_task_status(task_id, 'completed', screenshot_path)
        Repo->>DB: UPDATE tasks SET status='completed',<br/>screenshot_path=? WHERE id=?
    end
    
    ThreadPool-->>BG: ä»»åŠ¡ç»„åˆæ‰§è¡Œå®Œæˆ
    BG->>BG: é‡Šæ”¾ä¿¡å·é‡ï¼Œç§»é™¤RUNNING_KEYS
```

### å…³é”®æ—¶é—´ç‚¹

| é˜¶æ®µ | æ“ä½œ | è€—æ—¶ä¼°ç®— |
|------|------|---------|
| ä»»åŠ¡åˆ›å»º | ç”Ÿæˆ144ä¸ªä»»åŠ¡æ®µ | ~100ms |
| RTSPæ£€æŸ¥ | éªŒè¯æµå¯ç”¨æ€§ | ~2-5s |
| æ¸…ç†æ—§ä»»åŠ¡ | åˆ é™¤æ—§æ•°æ®å’Œæ–‡ä»¶ | ~500ms-2s |
| æ‰¹é‡æ’å…¥ | æ’å…¥144æ¡è®°å½• | ~200ms |
| åå°æ‰§è¡Œ | å¹¶è¡Œæˆªå›¾144ä¸ªä»»åŠ¡ | ~5-10åˆ†é’Ÿ |

---

## å›¾ç‰‡æŸ¥è¯¢ä¸å±•ç¤ºæµç¨‹

### è¯¦ç»†åºåˆ—å›¾

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Router as images.py
    participant Service as ImageService
    participant Repo as ImageRepository
    participant DB as Database
    participant FS as File System
    
    Client->>Router: GET /api/images?date=2025-11-01<br/>&task_ip=192.168.1.1&task_channel=c1
    Router->>Service: list_images(filters)
    
    Note over Service: å¤„ç†è¿‡æ»¤å‚æ•°
    Service->>Service: åˆå¹¶å‘åå…¼å®¹å‚æ•°<br/>(rtsp_ip â†’ task_ip, channel â†’ task_channel)
    Service->>Service: è§£æçŠ¶æ€åˆ—è¡¨<br/>(task_status_in â†’ List[str])
    
    Service->>Repo: get_tasks_with_filters(<br/>date, task_ip, task_channel,<br/>task_status, task_start_ts_gte, ...)
    
    Repo->>DB: SELECT * FROM tasks<br/>WHERE date=? AND ip=? AND channel=?<br/>AND status IN (?)<br/>AND start_ts >= ?<br/>ORDER BY index
    DB-->>Repo: tasks[288æ¡]
    Repo-->>Service: tasks[]
    
    Service->>Service: æå–task_ids: [1,2,3,...,288]
    
    Service->>Repo: get_screenshot_dict_by_task_ids(task_ids)
    Repo->>DB: SELECT * FROM screenshots<br/>WHERE task_id IN (1,2,3,...,288)
    DB-->>Repo: screenshots[]
    
    Note over Repo: æ„å»º {task_id: latest_screenshot} å­—å…¸
    Repo-->>Service: screenshot_dict{task_id: screenshot}
    
    loop éå†æ¯ä¸ªä»»åŠ¡
        Service->>Service: shot = screenshot_dict.get(task.id)
        Service->>Service: get_status_label(task, shot)
        
        alt æœ‰æˆªå›¾è®°å½•
            Service->>Service: path = Path(shot.file_path)
            Service->>Service: build_image_url(path)
            Service->>FS: æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            FS-->>Service: exists=True/False
            
            alt æ–‡ä»¶å­˜åœ¨
                Service->>Service: url = "/shots/2025-11-01/xxx.jpg"<br/>missing = False
            else æ–‡ä»¶ç¼ºå¤±
                Service->>Service: url = "/shots/2025-11-01/xxx.jpg"<br/>missing = True<br/>status_label = "missing"
            end
        else æ— æˆªå›¾è®°å½•
            Service->>Service: æ ¹æ®task.statusåˆ¤æ–­<br/>pending â†’ "å¾…æˆªå›¾"<br/>playing â†’ "æˆªå›¾ä¸­"<br/>failed â†’ "æˆªå›¾å¤±è´¥"<br/>completed â†’ "missing"
            Service->>Service: url = ""<br/>missing = True
        end
        
        Service->>Service: æå–task_ipå’Œtask_channel<br/>(ä»task.ip/channelæˆ–rtsp_urlè§£æ)
        
        Service->>Service: åº”ç”¨è¿‡æ»¤æ¡ä»¶
        
        alt é€šè¿‡æ‰€æœ‰è¿‡æ»¤
            Service->>Service: items.append({<br/>task_id, name, path, url,<br/>missing, task_status,<br/>status_label, task_date,<br/>task_ip, task_channel,<br/>task_start_ts, task_end_ts})
        end
    end
    
    Service-->>Router: {date: "2025-11-01", count: 288, items: [...]}
    Router-->>Client: 200 OK
```

### è¿‡æ»¤é€»è¾‘è¯´æ˜

**è¿‡æ»¤é¡ºåº**:
1. **æ•°æ®åº“æŸ¥è¯¢è¿‡æ»¤**: date, task_ip, task_channel, task_status, æ—¶é—´èŒƒå›´
2. **å†…å­˜è¿‡æ»¤**: name_eq, name_like, status_label, status_label_in, missing

**æ€§èƒ½ä¼˜åŒ–**:
- æ•°æ®åº“æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•å­—æ®µï¼ˆdate, ip, channelï¼‰
- æ‰¹é‡è·å–æˆªå›¾ï¼Œå‡å°‘æŸ¥è¯¢æ¬¡æ•°
- æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥æ‰¹é‡è¿›è¡Œ

---

## è‡ªåŠ¨è°ƒåº¦è§„åˆ™æ‰§è¡Œæµç¨‹

### è¯¦ç»†åºåˆ—å›¾

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Router as auto_schedule.py
    participant Service as AutoScheduleService
    participant Repo as AutoScheduleRepository
    participant DB as Database
    participant BG as Background Scheduler
    participant TaskService as TaskService
    participant TaskRepo as TaskRepository
    
    Note over Client,TaskRepo: ===== é˜¶æ®µ1: åˆ›å»ºè§„åˆ™ =====
    
    Client->>Router: POST /api/auto-schedule/rules<br/>{use_today: true, base_rtsp,<br/>channel: "c1", trigger_time: "18:00"}
    Router->>Service: create_rule(rule_data)
    
    Service->>Service: validate_rule_data()
    Note over Service: éªŒè¯æ—¥æœŸé€‰æ‹©ã€è§¦å‘æ—¶é—´æ ¼å¼ã€<br/>RTSPåœ°å€æ ¼å¼ã€é€šé“æ ¼å¼ã€é—´éš”åˆ†é’Ÿæ•°
    
    alt éªŒè¯å¤±è´¥
        Service-->>Router: HTTPException(400, detail)
        Router-->>Client: 400 Bad Request
    end
    
    Service->>Service: generate_rule_name()
    Note over Service: ä»base_rtspæå–IP<br/>ç”Ÿæˆ: "{ip}_{channel}_{trigger_time}"
    
    Service->>Repo: create(rule)
    Repo->>DB: INSERT INTO auto_schedule_rules<br/>(name, use_today, base_rtsp,<br/>channel, trigger_time, is_enabled)
    DB-->>Repo: rule_id
    Repo-->>Service: rule
    Service-->>Router: {id: rule_id, message: "è§„åˆ™ä¿å­˜æˆåŠŸ"}
    Router-->>Client: 200 OK
    
    Note over Client,TaskRepo: ===== é˜¶æ®µ2: å®šæ—¶æ£€æŸ¥ä¸æ‰§è¡Œ =====
    
    loop æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
        BG->>Repo: get_enabled_rules()
        Repo->>DB: SELECT * FROM auto_schedule_rules<br/>WHERE is_enabled = true
        DB-->>Repo: rules[]
        Repo-->>BG: rules[]
        
        loop éå†æ¯ä¸ªè§„åˆ™
            BG->>BG: è·å–å½“å‰æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰<br/>current_time = "18:00"
            BG->>BG: æ¯”è¾ƒ current_time == rule.trigger_time
            
            alt æ—¶é—´åŒ¹é…
                BG->>BG: ç¡®å®šç›®æ ‡æ—¥æœŸ<br/>if rule.use_today:<br/>  target_date = today()<br/>else:<br/>  target_date = rule.custom_date
                
                BG->>TaskService: ensure_tasks(<br/>date=target_date,<br/>base_rtsp=rule.base_rtsp,<br/>channel=rule.channel,<br/>interval_minutes=rule.interval_minutes)
                
                Note over TaskService: åˆ›å»ºå¹¶è¿è¡Œä»»åŠ¡ï¼ˆè§ä»»åŠ¡åˆ›å»ºæµç¨‹ï¼‰
                TaskService-->>BG: æ‰§è¡ŒæˆåŠŸ/å¤±è´¥
                
                alt æ‰§è¡ŒæˆåŠŸ
                    BG->>Repo: update_execution_info(<br/>rule_id,<br/>last_executed_at=now(),<br/>execution_count+=1,<br/>last_execution_status="success")
                    Repo->>DB: UPDATE auto_schedule_rules<br/>SET last_executed_at=?,<br/>execution_count=?,<br/>last_execution_status=?
                else æ‰§è¡Œå¤±è´¥
                    BG->>Repo: update_execution_info(<br/>rule_id,<br/>last_executed_at=now(),<br/>execution_count+=1,<br/>last_execution_status="failed",<br/>last_execution_error=error_msg)
                    Repo->>DB: UPDATE auto_schedule_rules<br/>SET last_executed_at=?,<br/>execution_count=?,<br/>last_execution_status=?,<br/>last_execution_error=?
                end
            end
        end
        
        BG->>BG: sleep(60)  # ç­‰å¾…1åˆ†é’Ÿ
    end
```

### æ‰§è¡Œæ—¶æœºè¯´æ˜

**æ—¶é—´åŒ¹é…é€»è¾‘**:
- ä½¿ç”¨åŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰
- ç²¾ç¡®åŒ¹é…åˆ°åˆ†é’Ÿï¼ˆHH:mmï¼‰
- æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œç¡®ä¿ä¸é—æ¼

**æ‰§è¡Œè®°å½•**:
- `last_executed_at`: ä¸Šæ¬¡æ‰§è¡Œæ—¶é—´
- `execution_count`: ç´¯è®¡æ‰§è¡Œæ¬¡æ•°
- `last_execution_status`: ä¸Šæ¬¡æ‰§è¡ŒçŠ¶æ€ï¼ˆsuccess/failedï¼‰
- `last_execution_error`: å¤±è´¥æ—¶çš„é”™è¯¯ä¿¡æ¯

---

## HLSæµè½¬æ¢æµç¨‹

### è¯¦ç»†åºåˆ—å›¾

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Router as utils.py
    participant Service as UtilsService
    participant Probe as probe_rtsp
    participant FFmpeg as FFmpegè¿›ç¨‹
    participant FS as File System
    participant Config as config.py
    
    Client->>Router: GET /api/hls/start?rtsp_url=rtsp://...
    Router->>Service: start_hls_stream(rtsp_url)
    
    Service->>Probe: probe_rtsp(rtsp_url, timeout=5)
    Note over Probe: ffmpeg -rtsp_transport tcp<br/>-stimeout 5000000<br/>-i rtsp_url -t 1 -f null -
    
    alt RTSPæ¢æµ‹æˆåŠŸ
        Probe-->>Service: (ok=True, err=None)
    else RTSPæ¢æµ‹å¤±è´¥
        Probe-->>Service: (ok=False, err="è¿æ¥è¶…æ—¶")
        Note over Service: è®°å½•è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ
    end
    
    Service->>Service: ç”Ÿæˆå”¯ä¸€é”®<br/>key = uuid.uuid4()
    Service->>Service: åˆ›å»ºè¾“å‡ºç›®å½•<br/>out_dir = HLS_BASE / key
    
    Service->>FFmpeg: start_hls(rtsp_url, out_dir, "index")
    Note over FFmpeg: ffmpeg -rtsp_transport tcp<br/>-i rtsp_url<br/>-c:v libx264 -preset veryfast<br/>-c:a aac -b:a 128k<br/>-f hls -hls_time 2<br/>-hls_list_size 5<br/>-hls_flags delete_segments<br/>output_dir/index.m3u8
    
    FFmpeg-->>Service: proc (Popenå¯¹è±¡)
    
    alt FFmpegå¯åŠ¨å¤±è´¥
        Service-->>Router: HTTPException(500, "FFmpegå¯åŠ¨å¤±è´¥")
        Router-->>Client: 500 Internal Server Error
    end
    
    Service->>Service: ç­‰å¾…m3u8æ–‡ä»¶ç”Ÿæˆ<br/>wait_time = 20ç§’<br/>poll_interval = 0.5ç§’
    
    loop è½®è¯¢æ£€æŸ¥ï¼ˆæœ€å¤š20ç§’ï¼‰
        Service->>FS: æ£€æŸ¥ index.m3u8 æ˜¯å¦å­˜åœ¨
        FS-->>Service: exists=True/False
        
        alt æ–‡ä»¶å·²ç”Ÿæˆ
            break é€€å‡ºå¾ªç¯
        else æ–‡ä»¶æœªç”Ÿæˆ
            Service->>FFmpeg: æ£€æŸ¥è¿›ç¨‹çŠ¶æ€ proc.poll()
            
            alt è¿›ç¨‹å·²é€€å‡º
                Service->>FFmpeg: proc.terminate()
                Service-->>Router: HTTPException(500, "FFmpegå¼‚å¸¸é€€å‡º")
                Router-->>Client: 500 Internal Server Error
            else è¿›ç¨‹è¿è¡Œä¸­
                Service->>Service: sleep(0.5)
            end
        end
    end
    
    alt è¶…æ—¶æœªç”Ÿæˆm3u8
        Service->>FFmpeg: proc.terminate()
        Service-->>Router: HTTPException(500, "æœªç”Ÿæˆm3u8")
        Router-->>Client: 500 Internal Server Error
    else m3u8ç”ŸæˆæˆåŠŸ
        Service->>Config: HLS_PROCS[key] = proc
        Service->>Service: m3u8_url = "/hls/{key}/index.m3u8"
        Service->>Service: warn = None if ok else "RTSPæ¢æµ‹å¤±è´¥..."
        
        Service-->>Router: {m3u8: m3u8_url, warn: warn}
        Router-->>Client: 200 OK
    end
    
    Note over Client,Config: å®¢æˆ·ç«¯ä½¿ç”¨è¿”å›çš„m3u8 URL<br/>é€šè¿‡ /hls/{key}/index.m3u8 è®¿é—®HLSæµ
```

### FFmpegå‚æ•°è¯´æ˜

**å…³é”®å‚æ•°**:
- `-rtsp_transport tcp`: ä½¿ç”¨TCPä¼ è¾“ï¼Œæ›´ç¨³å®š
- `-c:v libx264`: è§†é¢‘ç¼–ç ä¸ºH.264
- `-preset veryfast`: ç¼–ç é€Ÿåº¦é¢„è®¾
- `-f hls`: è¾“å‡ºæ ¼å¼ä¸ºHLS
- `-hls_time 2`: æ¯ä¸ªç‰‡æ®µ2ç§’
- `-hls_list_size 5`: æ’­æ”¾åˆ—è¡¨ä¿ç•™5ä¸ªç‰‡æ®µ
- `-hls_flags delete_segments`: è‡ªåŠ¨åˆ é™¤æ—§ç‰‡æ®µ

---

## ä»»åŠ¡é‡è¯•æµç¨‹

### è¯¦ç»†åºåˆ—å›¾

```mermaid
sequenceDiagram
    participant BG as é‡è¯•æ£€æŸ¥å™¨
    participant Repo as TaskRepository
    participant DB as Database
    participant Service as TaskService
    participant Cleanup as TaskCleanupService
    participant ThreadPool as ThreadPoolExecutor
    participant Capture as capture_frame
    
    Note over BG,Capture: æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
    
    loop æ¯å°æ—¶æ‰§è¡Œ
        BG->>Repo: get_failed_tasks_for_retry()
        Repo->>DB: SELECT * FROM tasks<br/>WHERE status = 'failed'<br/>AND retry_count < 3<br/>AND (next_retry_at IS NULL<br/>OR next_retry_at <= NOW())
        DB-->>Repo: failed_tasks[]
        Repo-->>BG: failed_tasks[]
        
        loop éå†æ¯ä¸ªå¤±è´¥ä»»åŠ¡
            BG->>BG: è®¡ç®—ä¸‹æ¬¡é‡è¯•æ—¶é—´<br/>next_retry_at = now() + backoff_time<br/>(é‡è¯•æ¬¡æ•°è¶Šå¤šï¼Œç­‰å¾…æ—¶é—´è¶Šé•¿)
            
            BG->>Cleanup: æ¸…ç†ä»»åŠ¡æ•°æ®<br/>(åˆ é™¤æ—§æˆªå›¾ã€OCRè®°å½•)
            Cleanup->>DB: DELETE FROM screenshots WHERE task_id=?
            Cleanup->>DB: DELETE FROM ocr_results WHERE screenshot_id IN (...)
            Cleanup->>FS: åˆ é™¤æˆªå›¾æ–‡ä»¶
            
            BG->>Repo: update_task_status(<br/>task_id,<br/>status='pending',<br/>retry_count+=1,<br/>next_retry_at=next_retry_at)
            Repo->>DB: UPDATE tasks SET<br/>status='pending',<br/>retry_count=?,<br/>next_retry_at=?
            
            BG->>ThreadPool: æäº¤ä»»åŠ¡é‡æ–°æ‰§è¡Œ
            ThreadPool->>Capture: capture_frame(...)
            Capture-->>ThreadPool: æ‰§è¡Œç»“æœ
            
            alt é‡è¯•æˆåŠŸ
                ThreadPool->>Repo: update_task_status('completed')
            else é‡è¯•å¤±è´¥
                ThreadPool->>Repo: update_task_status('failed')
                Note over Repo: å¦‚æœretry_count >= 3<br/>ä¸å†è®¾ç½®next_retry_at<br/>ä»»åŠ¡æ°¸ä¹…å¤±è´¥
            end
        end
        
        BG->>BG: sleep(3600)  # ç­‰å¾…1å°æ—¶
    end
```

### é‡è¯•ç­–ç•¥

**é‡è¯•æ¬¡æ•°**: æœ€å¤š3æ¬¡

**é€€é¿ç­–ç•¥**: 
- ç¬¬1æ¬¡é‡è¯•: ç«‹å³é‡è¯•
- ç¬¬2æ¬¡é‡è¯•: ç­‰å¾…1å°æ—¶åé‡è¯•
- ç¬¬3æ¬¡é‡è¯•: ç­‰å¾…2å°æ—¶åé‡è¯•

**é‡è¯•æ¡ä»¶**:
- `status = 'failed'`
- `retry_count < 3`
- `next_retry_at <= NOW()` æˆ– `next_retry_at IS NULL`

---

## æ•°æ®ä¸€è‡´æ€§ä¿è¯

### äº‹åŠ¡å¤„ç†

```mermaid
sequenceDiagram
    participant Service
    participant Repo
    participant DB
    
    Service->>DB: BEGIN TRANSACTION
    
    Service->>Repo: create_task()
    Repo->>DB: INSERT INTO tasks
    
    Service->>Repo: create_screenshot()
    Repo->>DB: INSERT INTO screenshots
    
    alt æ‰€æœ‰æ“ä½œæˆåŠŸ
        Service->>DB: COMMIT
        DB-->>Service: äº‹åŠ¡æäº¤æˆåŠŸ
    else ä»»ä½•æ“ä½œå¤±è´¥
        Service->>DB: ROLLBACK
        DB-->>Service: äº‹åŠ¡å›æ»š
    end
```

### çŠ¶æ€åè°ƒæœºåˆ¶

**é—®é¢˜**: ä»»åŠ¡çŠ¶æ€å¯èƒ½ä¸å®é™…æ‰§è¡Œæƒ…å†µä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**: `TaskRepository.reconcile_task_status()`

```python
# æ£€æŸ¥é€»è¾‘
1. æŸ¥è¯¢ status='playing' ä½† updated_at è¶…è¿‡1å°æ—¶çš„ä»»åŠ¡
2. æ£€æŸ¥æ˜¯å¦æœ‰æˆªå›¾è®°å½•
3. å¦‚æœæœ‰æˆªå›¾ â†’ æ›´æ–°ä¸º 'completed'
4. å¦‚æœæ²¡æœ‰æˆªå›¾ â†’ æ›´æ–°ä¸º 'failed'
```

---

## é”™è¯¯å¤„ç†æµç¨‹

### ç»Ÿä¸€é”™è¯¯å¤„ç†

```mermaid
sequenceDiagram
    participant Client
    participant Router
    participant Service
    participant Repo
    participant DB
    
    Client->>Router: APIè¯·æ±‚
    Router->>Service: è°ƒç”¨æœåŠ¡æ–¹æ³•
    
    alt ä¸šåŠ¡é€»è¾‘é”™è¯¯
        Service-->>Router: HTTPException(400, "ä¸šåŠ¡é”™è¯¯")
        Router-->>Client: 400 Bad Request
    else æ•°æ®åº“é”™è¯¯
        Repo->>DB: æ•°æ®åº“æ“ä½œ
        DB-->>Repo: DatabaseError
        Repo-->>Service: å¼‚å¸¸ä¼ æ’­
        Service-->>Router: HTTPException(500, "æ•°æ®åº“é”™è¯¯")
        Router-->>Client: 500 Internal Server Error
    else å¤–éƒ¨æœåŠ¡é”™è¯¯
        Service->>External: è°ƒç”¨å¤–éƒ¨æœåŠ¡
        External-->>Service: ConnectionError
        Service-->>Router: HTTPException(503, "æœåŠ¡ä¸å¯ç”¨")
        Router-->>Client: 503 Service Unavailable
    end
```

### é”™è¯¯ç è¯´æ˜

| HTTPçŠ¶æ€ç  | è¯´æ˜ | ç¤ºä¾‹ |
|-----------|------|------|
| 200 | æˆåŠŸ | æŸ¥è¯¢æˆåŠŸ |
| 201 | åˆ›å»ºæˆåŠŸ | ä»»åŠ¡åˆ›å»ºæˆåŠŸ |
| 400 | è¯·æ±‚é”™è¯¯ | å‚æ•°éªŒè¯å¤±è´¥ |
| 404 | èµ„æºä¸å­˜åœ¨ | ä»»åŠ¡ä¸å­˜åœ¨ |
| 500 | æœåŠ¡å™¨é”™è¯¯ | æ•°æ®åº“é”™è¯¯ã€FFmpegé”™è¯¯ |
| 503 | æœåŠ¡ä¸å¯ç”¨ | RTSPæµä¸å¯ç”¨ |

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2025-01-XX  
**ç»´æŠ¤è€…**: QJZH Team

