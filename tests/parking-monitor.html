<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ™ºèƒ½åœè½¦ç›‘æ§ - é«˜æ–°åœè½¦åœº AåŒº</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'status-green': '#10B981',
            'status-red': '#EF4444',
            'status-yellow': '#F59E0B'
          }
        }
      }
    }
  </script>
  <style>
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      border-radius: 0.5rem;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .spot-card:hover {
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body class="bg-gray-50 p-4 md:p-6">

<!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
<div class="bg-white rounded-lg shadow p-4 mb-6">
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-2">
    <div>
      <h1 class="text-xl font-bold text-gray-800">é«˜æ–°åœè½¦åœº Â· AåŒºï¼ˆé€šé“ c1ï¼‰</h1>
      <p class="text-sm text-gray-500">æœ€åæ›´æ–°ï¼š<span id="last-update-time">18:39:05</span>ï¼ˆ<span id="time-ago">1ç§’å‰</span>ï¼‰</p>
    </div>
    <div class="flex items-center gap-3">
      <span id="system-status" class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
        ç³»ç»Ÿæ­£å¸¸
      </span>
      <button id="toggle-debug" class="text-xs text-blue-600 hover:underline">å¼€å¯è°ƒè¯•</button>
      <button id="toggle-filter" class="px-3 py-1 bg-blue-50 text-blue-700 rounded text-xs">ä»…çœ‹å¼‚å¸¸</button>
    </div>
  </div>
</div>

<!-- è½¦ä½ç½‘æ ¼å®¹å™¨ -->
<div id="spots-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4"></div>

<!-- æœ€è¿‘äº‹ä»¶ï¼ˆå¯é€‰ï¼‰ -->
<div id="events-section" class="mt-8 bg-white rounded-lg shadow p-4 hidden">
  <h2 class="text-lg font-semibold mb-3">æœ€è¿‘çŠ¶æ€å˜åŒ–</h2>
  <ul id="events-list" class="space-y-2 text-sm"></ul>
</div>

<!-- æ¨¡æ€æ¡†å ä½ï¼ˆåˆå§‹éšè—ï¼‰ -->
<div id="modal-container"></div>

<script>
// ===== æ¨¡æ‹Ÿæ•°æ®ï¼ˆå®é™…åº”ä» WebSocket æˆ– API è·å–ï¼‰=====
const spotsData = [
  { id: 'GXSL001', name: '01', status: 'occupied', confidence: 0.77, similarity: 84.3, uncertain: true, interference: ['æš—å…‰', 'é®æŒ¡'] },
  { id: 'GXSL002', name: '02', status: 'occupied', confidence: 0.92, similarity: 91.2, uncertain: false, interference: [] },
  { id: 'GXSL003', name: '03', status: 'empty', confidence: null, similarity: null, uncertain: false, interference: [] },
  { id: 'GXSL004', name: '04', status: 'occupied', confidence: 0.88, similarity: 89.1, uncertain: false, interference: [] },
  { id: 'GXSL005', name: '05', status: 'occupied', confidence: 0.85, similarity: 87.5, uncertain: false, interference: [] },
  { id: 'GXSL006', name: '06', status: 'occupied', confidence: 0.63, similarity: 83.7, uncertain: true, interference: ['æš—å…‰'] }
];

const recentEvents = [
  { time: '18:39:02', spot: 'GXSL006', type: 'arrive', similarity: 83.7 },
  { time: '18:38:30', spot: 'GXSL003', type: 'leave' }
];

// ===== çŠ¶æ€ç®¡ç† =====
let debugMode = false;
let filterUncertain = true; // é»˜è®¤åªçœ‹å¼‚å¸¸
let selectedSpot = null;

// ===== å·¥å…·å‡½æ•° =====
function getDisplayStatus(spot) {
  if (spot.uncertain) return 'æœ‰è½¦?';
  return spot.status === 'occupied' ? 'æœ‰è½¦' : 'ç©º';
}

function getStatusColor(spot) {
  if (spot.uncertain) return 'border-yellow-400 ring-yellow-400';
  if (spot.status === 'occupied') return 'border-green-500 ring-green-500';
  return 'border-red-500 ring-red-500';
}

function getTextClass(spot) {
  if (spot.uncertain) return 'text-yellow-600 font-medium';
  if (spot.status === 'occupied') return 'text-green-600 font-medium';
  return 'text-red-600 font-medium';
}

function renderSpots() {
  const grid = document.getElementById('spots-grid');
  let filtered = filterUncertain ? spotsData.filter(s => s.uncertain) : spotsData;

  grid.innerHTML = filtered.map(spot => `
    <div class="bg-white rounded-lg shadow cursor-pointer spot-card ${getStatusColor(spot)}"
         data-id="${spot.id}">
      <div class="p-3 text-center">
        <div class="font-semibold text-gray-800">${spot.name}</div>
        <div class="mt-1 text-sm ${getTextClass(spot)}">${getDisplayStatus(spot)}</div>
        ${spot.confidence !== null ? `<div class="mt-1 text-xs text-gray-500">${Math.round(spot.confidence * 100)}%</div>` : ''}
        ${debugMode && spot.interference.length > 0 ? `
          <div class="mt-1 flex justify-center text-xs">
            ${spot.interference.includes('æš—å…‰') ? '<span class="text-blue-500">ğŸŒ™</span>' : ''}
            ${spot.interference.includes('é®æŒ¡') ? '<span class="text-purple-500">ğŸŒ³</span>' : ''}
            ${spot.confidence < 0.7 ? '<span class="text-yellow-500">âš ï¸</span>' : ''}
          </div>
        ` : ''}
      </div>
    </div>
  `).join('');

  // ç»‘å®šç‚¹å‡»äº‹ä»¶
  document.querySelectorAll('.spot-card').forEach(card => {
    card.addEventListener('click', () => {
      const id = card.dataset.id;
      selectedSpot = spotsData.find(s => s.id === id);
      openModal();
    });
  });

  // æ›´æ–°ç³»ç»ŸçŠ¶æ€
  const uncertainCount = spotsData.filter(s => s.uncertain).length;
  const statusEl = document.getElementById('system-status');
  if (uncertainCount === 0) {
    statusEl.className = 'px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
    statusEl.textContent = 'ç³»ç»Ÿæ­£å¸¸';
  } else {
    statusEl.className = 'px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
    statusEl.textContent = `æ³¨æ„ï¼š${uncertainCount}ä¸ªè½¦ä½è¯†åˆ«ä¸ç¨³å®š`;
  }

  // æ˜¾ç¤º/éšè—äº‹ä»¶åŒº
  const eventsSection = document.getElementById('events-section');
  if (recentEvents.length > 0) {
    eventsSection.classList.remove('hidden');
    const list = document.getElementById('events-list');
    list.innerHTML = recentEvents.map(e => `
      <li>
        <span class="font-mono text-gray-500">${e.time}</span>
        â†’ <span class="font-medium">${e.spot}</span>:
        <span class="${e.type === 'arrive' ? 'text-green-600' : 'text-red-600'}">
          ${e.type === 'arrive' ? 'è½¦è¾†è¿›å…¥' : 'è½¦è¾†ç¦»å¼€'}
        </span>
        ${e.similarity ? `<span class="text-gray-500 ml-2">(ç›¸ä¼¼åº¦: ${e.similarity}%)</span>` : ''}
      </li>
    `).join('');
  }
}

function openModal() {
  if (!selectedSpot) return;

  const modalHTML = `
    <div class="modal-overlay">
      <div class="modal-content">
        <div class="p-4 border-b flex justify-between items-center">
          <h3 class="font-bold">${selectedSpot.name} è¯¦æƒ…</h3>
          <button id="close-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div class="p-4 space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-gray-500">å½“å‰æˆªå›¾</p>
              <div class="w-full border rounded mt-1 bg-gray-100 h-32 flex items-center justify-center text-gray-400">
                å›¾åƒå ä½ï¼ˆå®é™…è·¯å¾„ï¼š..._c1.jpgï¼‰
              </div>
            </div>
            <div>
              <p class="text-sm text-gray-500">ä¸Šä¸€å¸§ï¼ˆ18:38:55ï¼‰</p>
              <div class="w-full border rounded mt-1 bg-gray-100 h-32 flex items-center justify-center text-gray-400">
                å›¾åƒå ä½
              </div>
            </div>
          </div>

          <div class="text-sm space-y-1">
            <p><span class="font-medium">å½“å‰çŠ¶æ€ï¼š</span>${getDisplayStatus(selectedSpot)}</p>
            <p><span class="font-medium">YOLO ç½®ä¿¡åº¦ï¼š</span>${Math.round(selectedSpot.confidence * 100)}%</p>
            <p><span class="font-medium">ç‰¹å¾ç›¸ä¼¼åº¦ï¼š</span>${selectedSpot.similarity}%</p>
            <p><span class="font-medium">å¹²æ‰°å› ç´ ï¼š</span>${selectedSpot.interference.length ? selectedSpot.interference.join(', ') : 'æ— '}</p>
          </div>

          <div class="flex gap-2 pt-2">
            <button id="confirm-occupied" class="px-3 py-1 bg-green-100 text-green-700 rounded text-sm">âœ“ ç¡®è®¤æœ‰è½¦</button>
            <button id="confirm-empty" class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm">âœ— ç¡®è®¤ä¸ºç©º</button>
            <button id="modal-close-btn" class="px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm">å…³é—­</button>
          </div>
        </div>
      </div>
    </div>
  `;

  document.getElementById('modal-container').innerHTML = modalHTML;

  // ç»‘å®šæŒ‰é’®äº‹ä»¶
  document.getElementById('close-modal').onclick = closeModal;
  document.getElementById('modal-close-btn').onclick = closeModal;
  document.getElementById('confirm-occupied').onclick = () => confirmStatus('occupied');
  document.getElementById('confirm-empty').onclick = () => confirmStatus('empty');
}

function closeModal() {
  document.getElementById('modal-container').innerHTML = '';
  selectedSpot = null;
}

function confirmStatus(status) {
  alert(`âœ… å·²äººå·¥ç¡®è®¤ ${selectedSpot.name} ä¸º ${status === 'occupied' ? 'æœ‰è½¦' : 'ç©º'}`);
  // è¿™é‡Œå¯è°ƒç”¨ fetch() æäº¤åˆ°åç«¯
  closeModal();
}

// ===== åˆå§‹åŒ–äº‹ä»¶ç»‘å®š =====
document.getElementById('toggle-debug').addEventListener('click', () => {
  debugMode = !debugMode;
  document.getElementById('toggle-debug').textContent = debugMode ? 'å…³é—­è°ƒè¯•' : 'å¼€å¯è°ƒè¯•';
  renderSpots();
});

document.getElementById('toggle-filter').addEventListener('click', () => {
  filterUncertain = !filterUncertain;
  document.getElementById('toggle-filter').textContent = filterUncertain ? 'æ˜¾ç¤ºå…¨éƒ¨' : 'ä»…çœ‹å¼‚å¸¸';
  renderSpots();
});

// ===== å¯åŠ¨ =====
renderSpots();

// æ¨¡æ‹Ÿæ—¶é—´æ›´æ–°
setInterval(() => {
  document.getElementById('time-ago').textContent = 'åˆšåˆš';
}, 1000);
</script>

</body>
</html>