# 停车位车辆变化识别逻辑说明

## 一、整体流程

### 1. 主处理流程 (`process_pending_screenshots`)

```
1. 从数据库读取待处理截图（yolo_status = 'pending'）
   ↓
2. 对每张截图：
   a. 标记为 'processing'
   b. 获取关联的 Task 和通道配置（ChannelConfig）
   c. 获取该通道的所有车位坐标（ParkingSpace）
   ↓
3. 对每个车位进行 YOLO 检测（_detect_space_occupancy）
   ↓
4. 与历史记录对比，判断变化类型
   ↓
5. 记录到数据库（ParkingChange 和 ParkingChangeSnapshot）
   ↓
6. 在图片上绘制检测区域（绿色框标记）
   ↓
7. 标记为 'done'
```

## 二、车位占用检测逻辑 (`_detect_space_occupancy`)

### 检测策略（混合策略）

#### **策略1：优先使用车位区域检测（精确检测）**

1. **车位坐标格式**：
   - `bbox_x1` = x（左上角X坐标）
   - `bbox_y1` = y（左上角Y坐标）
   - `bbox_x2` = width（宽度）
   - `bbox_y2` = height（高度）
   - 格式：`[x, y, width, height]`

2. **检测流程**：
   ```
   对每个车位：
   - 如果车位区域 >= 16x16 像素：
     → 直接在该车位区域内进行 YOLO 检测
     → 返回：是否有车（bool）、置信度（float）
   - 如果车位区域 < 16x16 像素：
     → 标记为需要回退方案
   ```

3. **优势**：
   - 只检测车位范围内的车辆，精度高
   - 不会误检其他车位的车辆
   - 性能好（检测区域小）

#### **策略2：回退方案（使用跟踪区域 + 交集计算）**

当车位区域太小（< 16x16）时，使用回退方案：

1. **跟踪区域（track_space）**：
   - 从 `ChannelConfig.track_space` 获取
   - 格式：JSON 字符串 `[x1, y1, x2, y2]` 或 `{"x1": ..., "y1": ..., "x2": ..., "y2": ...}`
   - 表示车辆可能出现的区域（通常比单个车位大）

2. **检测逻辑**：
   ```
   对每个车位：
   a. 计算车位与跟踪区域的交集
   b. 如果交集区域 >= 16x16：
      → 在交集区域内进行 YOLO 检测
   c. 如果交集区域 < 16x16，但车位区域 >= 16x16：
      → 在整个车位区域内进行检测
   d. 如果车位区域 < 16x16 且不在跟踪区域内：
      → 返回 False（无法检测）
   ```

3. **注意事项**：
   - **绝对不使用整张图的所有车辆进行检测**
   - 只检测车位坐标范围内或跟踪区域交集范围内的车辆

## 三、YOLO 区域检测逻辑 (`detect_cars_in_region`)

### 检测步骤

1. **区域预处理**：
   ```
   - 读取原始图片
   - 解析区域坐标 (x, y, width, height)
   - 添加 padding（默认10像素，提高检测率）
   - 确保坐标在图片范围内
   - 检查区域大小（最小 16x16 像素）
   ```

2. **ROI 裁剪**：
   ```
   - 从原图中裁剪出指定区域
   - 检查裁剪后的区域大小
   ```

3. **YOLO 推理**：
   ```
   - 将 ROI 保存为临时文件（因为当前版本的 ultralytics 不支持直接传入 numpy 数组）
   - 调用 YOLO 模型进行检测
   - 清理临时文件
   ```

4. **结果解析**：
   ```
   - 支持的车辆类型：car(2), motorcycle(3), bus(5), truck(7)
   - 过滤置信度 >= 阈值（默认 0.25）的检测结果
   - 返回：是否有车辆（bool）、最高置信度（float）
   ```

### 关键参数

- **最小区域尺寸**：16x16 像素（降低阈值以提高小车位检测率）
- **区域 padding**：10 像素（在车位坐标基础上扩大，提高检测率）
- **置信度阈值**：0.25（默认，可通过环境变量 `YOLO_CONF_THRESHOLD` 调整）

## 四、历史状态对比逻辑 (`_get_prev_occupied_for_channel`)

### 对比原则

1. **严格按时间顺序对比**：
   ```
   - 不再局限于"同一 task_id"
   - 基于 channel_config_id + screenshot_id
   - 在整个时间线上连续比较：图1对比图2，图2对比图3，图3对比图4...
   - 可以跨 Task 连续追踪同一通道的车位变化
   ```

2. **时间间隔检查**：
   ```
   - 最大允许时间间隔：900秒（15分钟）
   - 截图间隔：10分钟
   - 容差：15分钟（允许一定的容差）
   - 如果时间间隔 > 15分钟：
     → 返回 None（跳过对比，避免跨时间段对比）
   ```

3. **查询逻辑**：
   ```sql
   SELECT * FROM parking_changes
   JOIN screenshots ON parking_changes.screenshot_id = screenshots.id
   WHERE channel_config_id = ?
     AND space_id = ?
     AND screenshots.created_at < current_screenshot_time
   ORDER BY screenshots.created_at DESC
   LIMIT 1
   ```

## 五、多帧确认机制

### 目的
减少误判，提高检测准确性。

### 确认逻辑

1. **检测到状态变化时**（`prev_occupied != curr_occupied`）：
   ```
   a. 查找前2帧的状态（prev2_occupied）
   b. 检查前2帧与上一帧的时间间隔（<= 900秒）
   ```

2. **确认规则**：
   ```
   情况1：前2帧状态一致，且与当前状态不同
   → 确认变化（confirmed_change = True）
   
   情况2：前2帧状态不一致
   → 需要更高置信度（>= 0.5）才确认变化
   
   情况3：只有1帧历史
   → 需要较高置信度（>= 0.4）才确认变化
   
   情况4：没有变化或第一张图
   → 不需要确认（confirmed_change = True）
   ```

3. **未通过确认的处理**：
   ```
   - 视为无变化（change_type = None）
   - 仍然记录到数据库，但标记为"无变化"
   ```

## 六、变化类型判断

### 判断逻辑

```
if prev_occupied is None:
    → 第一张截图（无历史记录）
    → change_type = None（无变化，作为基准）

elif prev_occupied == curr_occupied:
    → 状态未变化
    → change_type = None（无变化）

elif prev_occupied != curr_occupied:
    → 状态发生变化
    → 检查是否通过多帧确认
    
    if not confirmed_change:
        → 未通过确认，视为误判
        → change_type = None
    
    elif not prev_occupied and curr_occupied:
        → 进车（无车 → 有车）
        → change_type = "arrive"
        → TODO: 细粒度车辆识别（区分"换车"和"同一辆车返回"）
    
    elif prev_occupied and not curr_occupied:
        → 离开（有车 → 无车）
        → change_type = "leave"
        → TODO: 细粒度车辆识别（提取并保存车辆特征）
```

## 七、数据记录

### 1. ParkingChange 表（所有车位状态）

每条记录包含：
- `prev_occupied`: 上一张图的状态（None 表示"未知"）
- `curr_occupied`: 当前图的状态
- `change_type`: 变化类型（None/"arrive"/"leave"）
- `detection_confidence`: 检测置信度（0.0-1.0）

**注意**：所有车位都会记录，无论是否有变化。

### 2. ParkingChangeSnapshot 表（只记录有变化的截图）

只有当 `changed_count > 0` 时才创建快照记录：
- 用于前端"车位变化"页面展示
- 只展示"有变化"的截图

## 八、可视化标记

### 检测区域标记图（`_detected.jpg`）

1. **生成时机**：检测完成后自动生成
2. **标记内容**：
   - 绿色矩形框：标记实际检测的区域
   - 车位名称标签：在框的上方显示车位名称
3. **保存位置**：与原图同一目录，文件名格式：`原文件名_detected.jpg`

## 九、关键配置参数

### YOLO 检测参数

- `YOLO_MODEL_NAME`: 模型名称（默认：yolov8n.pt）
- `YOLO_CONF_THRESHOLD`: 置信度阈值（默认：0.25）
- `YOLO_MIN_REGION_SIZE`: 最小区域尺寸（默认：16）
- `YOLO_REGION_PADDING`: 区域 padding（默认：10）

### 时间间隔参数

- `max_time_gap_seconds`: 最大时间间隔（默认：900秒/15分钟）

### 多帧确认参数

- 前2帧状态一致：直接确认
- 前2帧状态不一致：需要置信度 >= 0.5
- 只有1帧历史：需要置信度 >= 0.4

## 十、待实现功能（TODO）

### 细粒度车辆识别

1. **进车时（arrive）**：
   - 提取当前车辆的视觉特征（颜色、车型、位置等）
   - 查找最近一次"离开"事件（同一车位）
   - 比对车辆特征
   - 如果特征差异大，标记为"换车"；如果相似，标记为"同一辆车返回"
   - 当前先标记为"arrive"，后续可以扩展为"arrive_new"和"arrive_return"

2. **离开时（leave）**：
   - 提取并保存车辆特征（用于后续比对）
   - 保存到数据库或缓存，关联到 space_id 和 screenshot_id

## 十一、错误处理

1. **图片文件不存在**：标记为 'failed'，记录错误信息
2. **通道配置不存在**：标记为 'done'，不产生变化记录
3. **YOLO 检测失败**：记录错误，继续处理下一张截图
4. **绘制检测区域失败**：不影响主流程，只记录警告

## 十二、性能优化

1. **单例模式**：YOLO 模型全局只加载一次，避免重复加载
2. **批量处理**：每次处理一批截图（默认10张）
3. **区域检测**：只检测车位范围内的车辆，不检测整张图
4. **临时文件**：使用临时文件传递 ROI 给 YOLO，检测后立即清理
