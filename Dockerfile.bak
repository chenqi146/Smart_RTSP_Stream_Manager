# Smart RTSP Stream Manager - Docker 镜像
# 使用官方 python:slim（不固定版本，由 Docker 自动拉取）
FROM python:slim

LABEL maintainer="SmartParkingSystem"
LABEL description="Smart RTSP Stream Manager - 按10分钟切片拉流、截图、车位变化检测"

# 安装系统依赖（OpenCV 等可能需要的库；新版 Debian 用 libgl1 替代 libgl1-mesa-glx）
RUN apt-get update && apt-get install -y --no-install-recommends \
    libgl1 \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    ffmpeg \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1

WORKDIR /app

# 先复制依赖文件，利用层缓存
COPY requirements.txt .

# 安装 Python 依赖
RUN pip install --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple && pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 复制项目代码（不含 .dockerignore 中排除的目录）
COPY . .

# 确保 YOLO 模型存在（若镜像内未包含，首次运行时会下载）
RUN mkdir -p /app/models /app/screenshots /app/hls /app/logs

# 若项目根或 app 下已有 yolov8n.pt，复制到统一路径供运行时使用
RUN if [ -f /app/models/yolov8n.pt ]; then true; \
    elif [ -f /app/app/yolov8n.pt ]; then cp /app/app/yolov8n.pt /app/models/ 2>/dev/null || true; fi

EXPOSE 8000

# 使用入口脚本：等待 MySQL → 初始化表 → 启动 uvicorn
COPY docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "10000", "--workers", "1"]
