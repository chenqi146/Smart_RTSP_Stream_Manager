# 部署指南

## 服务器信息
- **系统**: Ubuntu 22.04.2
- **IP地址**: 192.168.54.173
- **项目路径**: `/data/Smart_RTSP_Stream_Manager`

## 一、首次部署

### 1. 环境准备

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装基础依赖
sudo apt install -y python3 python3-venv python3-pip ffmpeg libgl1 libglib2.0-0

# 如果使用 MySQL（可选）
sudo apt install -y mysql-server
```

### 2. 上传代码

将项目代码上传到服务器的 `/data/Smart_RTSP_Stream_Manager` 目录。

### 3. 创建虚拟环境

```bash
cd /data/Smart_RTSP_Stream_Manager
python3 -m venv .venv
source .venv/bin/activate
```

### 4. 安装依赖

```bash
# 使用国内镜像加速（推荐）
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple --timeout 120 --retries 3
```

如果遇到网络超时，可以：
- 单独安装大包：`pip install opencv-python-headless -i https://pypi.tuna.tsinghua.edu.cn/simple --timeout 180`
- 配置永久镜像源（见下方）

### 5. 配置数据库

#### 方式一：使用 MySQL（推荐生产环境）

```bash
# 创建数据库
mysql -u root -p
CREATE DATABASE smart_rtsp DEFAULT CHARACTER SET utf8mb4;
exit

# 设置环境变量
export MYSQL_USER=root
export MYSQL_PASSWORD=your_password
export MYSQL_HOST=127.0.0.1
export MYSQL_PORT=3306
export MYSQL_DB=smart_rtsp
export USE_SQLITE_FALLBACK=false
```

**配置 MySQL 允许外部工具连接：**

1. **允许远程连接（可选，如果需要从外部工具连接）**

```bash
# 编辑 MySQL 配置文件
sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf

# 找到 bind-address 行，修改为：
bind-address = 0.0.0.0  # 允许所有 IP 连接
# 或
bind-address = 192.168.54.173  # 只允许特定 IP

# 重启 MySQL
sudo systemctl restart mysql
```

2. **创建远程访问用户（推荐）**

```bash
mysql -u root -p

# 创建专用用户（更安全）
CREATE USER 'smart_rtsp_user'@'%' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON smart_rtsp.* TO 'smart_rtsp_user'@'%';
FLUSH PRIVILEGES;
exit
```

3. **开放防火墙端口**

```bash
# 开放 MySQL 端口（3306）
sudo ufw allow 3306/tcp
sudo ufw reload
```

4. **外部工具连接信息**

使用以下信息在数据库管理工具中连接：

- **主机**: `192.168.54.173`（服务器 IP）
- **端口**: `3306`
- **数据库名**: `smart_rtsp`
- **用户名**: `root` 或 `smart_rtsp_user`（如果创建了专用用户）
- **密码**: 你设置的密码

**常用数据库管理工具：**
- **Navicat**: 支持 Windows/Mac/Linux
- **DBeaver**: 免费开源，跨平台
- **MySQL Workbench**: MySQL 官方工具
- **DataGrip**: JetBrains 出品（付费）
- **phpMyAdmin**: Web 界面（需要安装）

**连接示例（DBeaver）：**
1. 新建连接 → MySQL
2. 主机：`192.168.54.173`
3. 端口：`3306`
4. 数据库：`smart_rtsp`
5. 用户名/密码：填写你的凭据
6. 测试连接 → 完成

#### 方式二：使用 SQLite（开发/测试）

```bash
# 默认会自动使用 SQLite，无需配置
# 如需禁用 MySQL 回退，设置：
export USE_SQLITE_FALLBACK=true
```

**SQLite 数据库文件位置：**
- 文件路径：`/data/Smart_RTSP_Stream_Manager/smart_rtsp.sqlite3`

**查看 SQLite 数据库：**
- **DBeaver**: 支持 SQLite，直接打开 `.sqlite3` 文件
- **DB Browser for SQLite**: 免费工具
- **命令行**: `sqlite3 smart_rtsp.sqlite3`
- **VS Code 插件**: SQLite Viewer

**注意**: SQLite 是文件数据库，不能像 MySQL 那样远程连接。如果需要远程查看，可以：
1. 通过 SFTP 下载数据库文件到本地查看
2. 使用 API 接口查询数据
3. 在服务器上使用命令行工具查看

### 6. 启动服务

#### 方式一：使用重启脚本（推荐）

```bash
cd /data/Smart_RTSP_Stream_Manager
chmod +x deploy_and_start.sh
./deploy_and_start.sh 8000  # 默认端口 8000，可自定义
```

#### 方式二：手动启动

```bash
cd /data/Smart_RTSP_Stream_Manager
source .venv/bin/activate

# 前台运行（开发模式，带热重载）
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

# 后台运行（生产模式）
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > logs/app.log 2>&1 &
```

#### 方式三：使用 systemd（推荐生产环境）

创建服务文件 `/etc/systemd/system/smart-rtsp.service`:

```ini
[Unit]
Description=Smart RTSP Stream Manager
After=network.target mysql.service

[Service]
Type=simple
User=root
WorkingDirectory=/data/Smart_RTSP_Stream_Manager
Environment="MYSQL_USER=root"
Environment="MYSQL_PASSWORD=your_password"
Environment="MYSQL_HOST=127.0.0.1"
Environment="MYSQL_DB=smart_rtsp"
Environment="USE_SQLITE_FALLBACK=false"
ExecStart=/data/Smart_RTSP_Stream_Manager/.venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启用并启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable smart-rtsp
sudo systemctl start smart-rtsp
sudo systemctl status smart-rtsp
```

### 7. 防火墙配置

```bash
# 开放端口
sudo ufw allow 8000/tcp
sudo ufw reload
```

### 8. 验证部署

访问以下地址验证服务是否正常运行：

- API 文档: `http://192.168.54.173:8000/docs`
- 健康检查: `http://192.168.54.173:8000/healthz`

## 二、更新代码后重启服务

### 方法一：使用重启脚本（最简单）

```bash
cd /data/Smart_RTSP_Stream_Manager
./deploy_and_start.sh 8000
```

### 方法二：手动重启

#### 2.1 查找进程

```bash
# 查找 uvicorn 进程
ps aux | grep uvicorn | grep app.main

# 或通过端口查找
lsof -i:8000
```

#### 2.2 停止服务

```bash
# 方式1: 通过 PID 停止（优雅停止）
kill -15 <PID>

# 方式2: 通过端口停止
kill -15 $(lsof -ti:8000)

# 方式3: 强制停止（如果优雅停止失败）
kill -9 <PID>
```

#### 2.3 重新启动

```bash
cd /data/Smart_RTSP_Stream_Manager
source .venv/bin/activate

# 如果依赖有更新，先安装
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 启动服务
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > logs/app.log 2>&1 &
```

### 方法三：使用 systemd（如果已配置）

```bash
# 更新代码后，重启服务
sudo systemctl restart smart-rtsp

# 查看状态
sudo systemctl status smart-rtsp

# 查看日志
sudo journalctl -u smart-rtsp -f
```

## 三、常用操作

### 查看服务状态

```bash
# 查看进程
ps aux | grep uvicorn

# 查看端口占用
netstat -tlnp | grep 8000
# 或
lsof -i:8000

# 查看日志（如果使用 nohup）
tail -f /data/Smart_RTSP_Stream_Manager/logs/app.log

# 查看日志（如果使用 systemd）
sudo journalctl -u smart-rtsp -f
```

### 停止服务

```bash
# 方式1: 使用重启脚本（会先停止再启动）
./deploy_and_start.sh

# 方式2: 手动停止
kill -15 $(lsof -ti:8000)

# 方式3: systemd
sudo systemctl stop smart-rtsp
```

### 更新依赖

```bash
cd /data/Smart_RTSP_Stream_Manager
source .venv/bin/activate
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple --upgrade
```

## 四、配置优化

### 配置 pip 镜像源（永久）

创建或编辑 `~/.pip/pip.conf`:

```ini
[global]
index-url = https://pypi.tuna.tsinghua.edu.cn/simple
timeout = 120
trusted-host = pypi.tuna.tsinghua.edu.cn
```

### 环境变量配置（永久）

创建 `.env` 文件或添加到 `~/.bashrc`:

```bash
export MYSQL_USER=root
export MYSQL_PASSWORD=your_password
export MYSQL_HOST=127.0.0.1
export MYSQL_PORT=3306
export MYSQL_DB=smart_rtsp
export USE_SQLITE_FALLBACK=false
```

## 五、故障排查

### 服务无法启动

1. **检查端口占用**
   ```bash
   lsof -i:8000
   ```

2. **检查虚拟环境**
   ```bash
   source .venv/bin/activate
   python --version
   which uvicorn
   ```

3. **检查依赖**
   ```bash
   pip list | grep fastapi
   pip list | grep uvicorn
   ```

4. **查看错误日志**
   ```bash
   tail -f logs/app.log
   ```

### 数据库连接失败

1. **检查 MySQL 服务**
   ```bash
   sudo systemctl status mysql
   ```

2. **测试连接**
   ```bash
   mysql -u root -p -h 127.0.0.1
   ```

3. **检查环境变量**
   ```bash
   env | grep MYSQL
   ```

### FFmpeg 不可用

```bash
# 检查 FFmpeg
ffmpeg -version

# 如果未安装
sudo apt install -y ffmpeg
```

## 六、性能优化建议

1. **使用多进程（生产环境）**
   ```bash
   uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
   ```

2. **使用反向代理（Nginx）**
   - 配置 Nginx 反向代理到 `127.0.0.1:8000`
   - 启用 HTTPS
   - 静态文件服务

3. **数据库优化**
   - 使用连接池
   - 添加索引
   - 定期清理旧数据

## 七、数据库管理

### MySQL 数据库管理

#### 查看数据库内容

**方式一：使用命令行**
```bash
mysql -u root -p
USE smart_rtsp;
SHOW TABLES;
SELECT * FROM tasks LIMIT 10;
SELECT * FROM screenshots LIMIT 10;
SELECT * FROM ocr_results LIMIT 10;
exit
```

**方式二：使用外部工具（推荐）**
- 使用 Navicat、DBeaver 等工具连接（见上方配置说明）
- 可以可视化查看表结构、数据、执行 SQL 等

#### 常用 SQL 查询

```sql
-- 查看任务统计
SELECT date, status, COUNT(*) as count 
FROM tasks 
GROUP BY date, status;

-- 查看最近的截图
SELECT * FROM screenshots 
ORDER BY created_at DESC 
LIMIT 20;

-- 查看失败的任务
SELECT * FROM tasks 
WHERE status = 'failed' 
ORDER BY updated_at DESC;

-- 查看各日期的任务数量
SELECT date, COUNT(*) as total 
FROM tasks 
GROUP BY date 
ORDER BY date DESC;
```

### SQLite 数据库管理

```bash
# 进入项目目录
cd /data/Smart_RTSP_Stream_Manager

# 使用 sqlite3 命令行工具
sqlite3 smart_rtsp.sqlite3

# 在 sqlite3 中执行命令
.tables                    # 查看所有表
.schema tasks              # 查看表结构
SELECT * FROM tasks LIMIT 10;  # 查询数据
.quit                     # 退出
```

## 八、备份建议

1. **数据库备份**
   ```bash
   # MySQL
   mysqldump -u root -p smart_rtsp > backup_$(date +%Y%m%d).sql
   
   # SQLite
   cp smart_rtsp.sqlite3 backup_$(date +%Y%m%d).sqlite3
   ```

2. **代码备份**
   ```bash
   tar -czf backup_code_$(date +%Y%m%d).tar.gz /data/Smart_RTSP_Stream_Manager
   ```

3. **截图数据备份**
   ```bash
   tar -czf backup_screenshots_$(date +%Y%m%d).tar.gz screenshots/
   ```

