
该文档严格遵循你现有系统的分层架构、数据模型和后台任务机制，并将“高精度车位状态判定”无缝嵌入其中。

🚗 停车场车位状态判定系统 — 高精度自动化方案（Final v4.0）
版本：v4.0（与现有系统完全对齐）
最后更新：2025-12-20
适用系统：Smart RTSP Stream Manager (FastAPI + YOLOv8)

一、背景与目标
1.1 系统现状
已实现 RTSP 分段截图 → YOLO 车位检测 → parking_changes 记录 的完整链路。
当前 parking_changes 表记录了每张图中每个车位的 prev_occupied / curr_occupied / change_type。
后台任务 start_parking_change_detector 每5秒处理 yolo_status='pending' 的截图。
1.2 核心痛点
当前系统输出的是变化事件（arrive/leave），但业务真正需要的是每张图的最终状态：
Occupied：同辆车正在持续停放（计费中）
Empty：上辆车已确认离开（可触发待支付）

现有逻辑无法区分：
真实离场 vs 因干扰导致的单帧漏检
同车延续 vs 换车行为
1.3 最终目标
在不破坏现有 API 和数据结构的前提下，增强 parking_changes 的语义，使其能直接反映上述严谨状态，并支持：
跨天连续停车
抗强光/暗光/遮挡等干扰
自动触发待支付订单

二、整体设计原则

1. 兼容性优先：复用现有 parking_changes、parking_change_snapshots 表结构，仅增强其内容逻辑。
2. 状态驱动：将 curr_occupied 字段的含义从“本帧检测结果”升级为“可信最终状态”。
3. 轻量 ReID：利用 YOLO 检测框，在 yolo_detector 服务中增加特征提取，不引入新模型。
4. 跨天继承：通过查询历史 parking_changes 记录，实现状态延续。
5. 干扰自适应：根据图像质量动态调整判定策略。

三、关键技术改造点
3.1 数据模型增强（零结构变更）

在现有表基础上，复用字段，增强语义：

表 字段 新增/增强逻辑
---- ------ -------------
parking_changes curr_occupied 不再是原始检测结果，而是经过多帧平滑+特征比对后的最终状态
parking_changes detection_confidence 存储综合相似度得分（用于审计和阈值调优）
parking_changes change_type 保留，但其计算基于新 curr_occupied，更准确
screenshots yolo_status 流程不变，但内部处理逻辑升级
✅ 无需新增表或字段，完全向后兼容。

3.2 核心服务改造：yolo_detector 与 ParkingChangeService
改造点 1：yolo_detector.detect_cars_in_region
输入：车位坐标、截图路径
输出：不仅返回 (has_vehicle, confidence)，新增车辆视觉特征（JSON）
实现：集成 [特征提取算法](#附录-车辆视觉特征提取与比对算法)（HSV直方图+宽高比+雨刮）
改造点 2：ParkingChangeService._detect_space_occupancy
输入：当前截图的所有车位检测结果（含特征）
核心逻辑：
1. 加载历史状态：查询该车位上一张有效截图的 curr_occupied 和 vehicle_features（来自 parking_changes）。
2. 干扰分析：基于截图亮度/清晰度，判定当前帧干扰等级。
3. 状态决策（详见下文“状态决策引擎”）。
4. 特征比对：若当前有车且历史有车，计算相似度。
5. 输出：更新后的 curr_occupied、detection_confidence（=相似度）、change_type。
改造点 3：ParkingChangeService._get_prev_occupied_for_channel
增强：不仅返回 prev_occupied，同时返回上一帧的 vehicle_features。
跨天支持：查询时不限于当日，按时间倒序找最近一条记录。

3.3 状态决策引擎（核心逻辑）

对每个车位，执行以下决策流程：

mermaid
graph TD
A[获取当前检测结果<br/> has_car_curr, features_curr] --> B[获取历史状态<br/> has_car_prev, features_prev]
B --> C{当前帧干扰等级?}
C --> High D[启用高鲁棒模式]
C --> Normal E[标准模式]
D --> F[若 has_car_prev=True 且 has_car_curr=False,<br/>且无新车特征 → 维持 Occupied]
E --> G[执行特征比对]
G --> H{是否为同一辆车?}
H --> 是 I[curr_occupied = True]
H --> 否 J[结束上一车订单<br/>curr_occupied = True (新车)]
A --> K{has_car_curr?}
K --> 否 L[curr_occupied = False<br/>(确认离场)]
关键规则：
离场确认：只有当 has_car_curr=False 且 历史为 Occupied 且 非高干扰误判时，才设 curr_occupied=False。
换车识别：若 has_car_curr=True 但特征与历史不匹配，则隐式结束上一订单，并为新车开始计费。

3.4 后台任务集成
任务：start_parking_change_detector（位于 app/background/parking_change_worker.py）
流程不变：仍每5秒扫描 yolo_status='pending' 的截图。
内部升级：调用增强后的 ParkingChangeService，执行上述状态决策引擎。
输出：
写入 parking_changes 表（curr_occupied 为最终状态）
若 curr_occupied 由 True → False，则插入 parking_change_snapshots（触发待支付）

四、业务对接与输出
4.1 API 层（零改动）
所有现有 API（如 /api/parking_changes/analysis/{channel_config_id}）无需修改。
返回的 curr_occupied 字段现在具有最终状态语义，可直接用于：
前端车位看板（红/绿）
计费引擎（Occupied = 计费中）
支付系统（Empty = 触发待支付）
4.2 待支付触发逻辑
条件：parking_change_snapshots 中存在记录（即 change_count > 0 且包含 leave 类型）
动作：调用外部支付服务，传入 space_id, end_timestamp（=当前截图时间）

五、鲁棒性与干扰处理（系统级）

干扰类型 系统响应
---------- --------
强反光/过曝 降低 YOLO conf 阈值；若历史为 Occupied，允许单帧漏检
暗光/噪声 提高 YOLO conf 阈值；过滤小面积目标
树枝遮挡 容忍更低 IoU；依赖多帧一致性
跨天脏污 特征比对阈值从 0.85 降至 0.75
摄像头故障 若连续 N 段 curr_occupied 跳变，标记通道异常
所有策略均在 ParkingChangeService 内部实现，对上层透明。

六、部署与运维
6.1 配置项（新增）
在 app/core/config.py 或环境变量中增加：

python
特征比对阈值
VEHICLE_SIMILARITY_THRESHOLD_SAME_DAY = 0.85
VEHICLE_SIMILARITY_THRESHOLD_CROSS_DAY = 0.75
干扰判定参数
BRIGHTNESS_LOW_THRESHOLD = 40
BRIGHTNESS_HIGH_THRESHOLD = 220
CLARITY_THRESHOLD = 100
6.2 监控指标
parking_change_worker 处理延迟
各通道 curr_occupied 跳变率
特征比对平均耗时

七、总结

本方案在完全兼容你现有系统架构（FastAPI 分层、SQLAlchemy ORM、后台任务）和数据模型（parking_changes 表）的基础上，通过增强 YOLO 检测后的业务逻辑，实现了：

✅ 高精度车位状态判定（Occupied/Empty）
✅ 跨天连续停车支持
✅ 换车行为精准识别
✅ 强抗干扰能力（光照/遮挡/天气）
✅ 零 API 变更，平滑升级

系统输出的 curr_occupied 字段现在可直接、安全地用于计费与支付业务，真正做到了“这张图里，每个车位到底有没有车？”的终极目标。

附录：车辆视觉特征提取与比对算法（集成指南）

为便于集成，此处简述算法要点（详见此前详细文档）：

1. 特征提取（在 yolo_detector.py 中）：
输入：YOLO 检测框裁剪图
输出：{"color_hist_h": [...], "color_hist_s": [...], "aspect_ratio": 1.8, "has_rear_wiper": true}
方法：HSV 直方图（32 bins）+ 宽高比 + 后雨刮边缘检测

2. 特征比对（在 ParkingChangeService 中）：
使用 Hellinger 距离计算直方图相似度
加权融合颜色、形状、结构特征
同天阈值 ≥0.85，跨天 ≥0.75

3. 存储：
将特征 JSON 序列化后，存入 parking_changes.vehicle_features（需在模型中添加此字段）
💡 实施建议：先在 parking_changes 表中添加 vehicle_features JSON NULL 字段，然后逐步上线。


