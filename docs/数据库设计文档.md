# 数据库设计文档

## 一、数据库概述

- **数据库类型**：MySQL
- **字符集**：utf8mb4
- **数据库名**：smart_rtsp（可通过环境变量 `MYSQL_DB` 配置）
- **ORM框架**：SQLAlchemy 2.0+
- **表创建方式**：应用启动时自动创建（`Base.metadata.create_all`）

## 二、表关系图

```
NvrConfig (1) ──< (N) ChannelConfig (1) ──< (N) ParkingSpace
                                                      │
                                                      │
AutoScheduleRule (1) ──< (N) TaskBatch (1) ──< (N) Task (1) ──< (N) Screenshot (1) ──< (1) OcrResult
                                                                        │
                                                                        │
                                                              ParkingChange (N)
                                                              ParkingChangeSnapshot (N)
```

## 三、数据表详细说明

### 1. task_batches（任务批次表）

**表说明**：对应前端"任务列表"，一条记录代表某天某IP某通道某时间段的一批截图任务。

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | Integer | PK, AI, Index | 主键ID（任务批次） |
| date | String(10) | NOT NULL, Index | 任务所属日期，格式：YYYY-MM-DD |
| ip | String(64) | NULL, Index | 摄像头IP |
| channel | String(16) | NULL, Index | 通道编号（如 c1/c2/c3/c4） |
| base_rtsp | String(512) | NOT NULL | RTSP基础地址（不含时间段部分） |
| start_ts | BigInteger | NOT NULL | 这批任务整体的起始时间戳（秒） |
| end_ts | BigInteger | NOT NULL | 这批任务整体的结束时间戳（秒） |
| interval_minutes | Integer | NOT NULL | 截图间隔分钟数 |
| status | String(32) | DEFAULT 'pending' | 整批任务状态：pending/running/completed/failed/partial_failed |
| task_count | Integer | DEFAULT 0 | 子任务数量（tasks 条数） |
| created_from_rule_id | Integer | NULL, FK | 来源的自动排程规则ID（外键：auto_schedule_rules.id） |
| created_at | DateTime | DEFAULT UTC_NOW | 记录创建时间（UTC） |
| updated_at | DateTime | DEFAULT UTC_NOW, ON UPDATE | 记录最近更新时间（UTC） |

**关系**：
- 1:N → `tasks`（一个批次包含多个任务）

**索引**：
- PRIMARY KEY (id)
- INDEX (date)
- INDEX (ip)
- INDEX (channel)
- FOREIGN KEY (created_from_rule_id) REFERENCES auto_schedule_rules(id)

---

### 2. tasks（任务明细表）

**表说明**：一条记录代表某个日期、某个时间段、某个通道上的一次截图任务。

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | Integer | PK, AI, Index | 主键ID |
| batch_id | Integer | NULL, FK | 所属任务批次ID（外键：task_batches.id） |
| date | String(10) | NOT NULL, Index | 任务所属日期，格式：YYYY-MM-DD |
| index | Integer | NOT NULL | 当天内第几个任务段（从0开始的序号） |
| start_ts | BigInteger | NOT NULL | 任务开始时间的时间戳（秒） |
| end_ts | BigInteger | NOT NULL | 任务结束时间的时间戳（秒） |
| rtsp_url | String(512) | NOT NULL | 完整RTSP回放地址（包含IP、通道、起止时间） |
| ip | String(64) | NULL, Index | 摄像头IP（从rtsp_url冗余解析，便于按IP查询） |
| channel | String(16) | NULL, Index | 通道编号（如 c1/c2/c3/c4，便于按通道查询） |
| status | String(32) | DEFAULT 'pending' | 任务状态：pending/playing/completed/failed 等 |
| screenshot_path | String(512) | NULL | 最近一次截图文件的相对路径（相对于 screenshots 目录） |
| error | String(512) | NULL | 错误信息（最近一次失败原因） |
| retry_count | Integer | DEFAULT 0 | 已重试次数（最大3次） |
| next_retry_at | DateTime | NULL | 下次允许重试的时间（用于失败任务的重试调度） |
| created_at | DateTime | DEFAULT UTC_NOW | 记录创建时间（UTC） |
| updated_at | DateTime | DEFAULT UTC_NOW, ON UPDATE | 记录最近更新时间（UTC） |

**关系**：
- N:1 → `task_batches`（多个任务属于一个批次）
- 1:N → `screenshots`（一个任务可以有多张截图）
- 1:N → `parking_changes`（一个任务关联多个车位变化记录）
- 1:N → `parking_change_snapshots`（一个任务关联多个快照记录）

**索引**：
- PRIMARY KEY (id)
- INDEX (date)
- INDEX (ip)
- INDEX (channel)
- FOREIGN KEY (batch_id) REFERENCES task_batches(id)

---

### 3. screenshots（截图表）

**表说明**：记录每一次成功保存到磁盘的截图文件。

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | Integer | PK, AI, Index | 主键ID |
| task_id | Integer | NOT NULL, FK | 关联的任务ID（外键：tasks.id） |
| file_path | String(512) | NOT NULL | 截图文件相对路径（相对于 screenshots 目录） |
| hash_value | String(64) | NULL | 截图文件内容的哈希值（用于相似度去重，可能为空） |
| is_duplicate | Boolean | DEFAULT False | 是否为重复截图（true表示已被判定为重复） |
| kept_path | String(512) | NULL | 去重后被保留的那张截图路径（如果当前为重复图） |
| yolo_status | String(32) | NOT NULL, DEFAULT 'pending' | YOLO 检测状态：pending/processing/done/failed |
| yolo_last_error | String(512) | NULL | 最近一次 YOLO 检测失败的错误信息（如有） |
| created_at | DateTime | DEFAULT UTC_NOW | 截图生成时间（UTC） |

**关系**：
- N:1 → `tasks`（多张截图属于一个任务）
- 1:1 → `ocr_results`（一张截图对应一个OCR结果）
- 1:N → `parking_changes`（一张截图关联多个车位变化记录）
- 1:N → `parking_change_snapshots`（一张截图关联多个快照记录）

**索引**：
- PRIMARY KEY (id)
- FOREIGN KEY (task_id) REFERENCES tasks(id)

**特殊说明**：
- `yolo_status` 用于异步车位变化检测的状态管理
- `hash_value` 用于相似度去重（当前功能已停用，但字段保留）

---

### 4. ocr_results（OCR识别结果表）

**表说明**：记录每张截图上时间水印的识别/修正结果。

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | Integer | PK, AI, Index | 主键ID |
| screenshot_id | Integer | NOT NULL, FK, UNIQUE | 对应的截图ID（外键：screenshots.id） |
| detected_time | String(19) | NULL | OCR 自动识别出的时间字符串（格式：YYYY-MM-DD HH:MM:SS） |
| detected_timestamp | BigInteger | NULL | detected_time 对应的时间戳（秒或毫秒） |
| confidence | Float | NULL | OCR 识别置信度（0.0~1.0，数值越大表示越可信） |
| is_manual_corrected | Boolean | DEFAULT False | 是否已被人工修正（True 表示 corrected_* 字段有效） |
| corrected_time | String(19) | NULL | 人工修正后的时间字符串（格式：YYYY-MM-DD HH:MM:SS） |
| corrected_timestamp | BigInteger | NULL | 人工修正时间的时间戳 |
| created_at | DateTime | DEFAULT UTC_NOW | 记录创建时间（UTC） |
| updated_at | DateTime | DEFAULT UTC_NOW, ON UPDATE | 记录最近更新时间（UTC） |

**关系**：
- 1:1 → `screenshots`（一个OCR结果对应一张截图）

**索引**：
- PRIMARY KEY (id)
- FOREIGN KEY (screenshot_id) REFERENCES screenshots(id)
- UNIQUE (screenshot_id)

**特殊说明**：
- 当前OCR功能已移除，但表结构保留用于兼容

---

### 5. auto_schedule_rules（自动排程规则表）

**表说明**：定义每天定时自动生成/运行截图任务的规则。

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | Integer | PK, AI, Index | 主键ID |
| name | String(128) | NULL | 规则名称（可选，用于在界面上区分不同规则） |
| use_today | Boolean | DEFAULT True | 是否使用当天日期（True=当天，False=使用 custom_date） |
| custom_date | String(10) | NULL | 自定义日期（当 use_today=False 时生效，格式：YYYY-MM-DD） |
| base_rtsp | String(512) | NOT NULL | RTSP 基础地址（不含通道和时间段部分） |
| channel | String(16) | NOT NULL | 通道编号（c1-c4） |
| interval_minutes | Integer | DEFAULT 10 | 截图间隔分钟数（例如：10表示每10分钟一个任务段） |
| trigger_time | String(5) | NOT NULL | 每天触发时间（HH:mm格式，如"18:00"） |
| is_enabled | Boolean | DEFAULT True | 是否启用该规则（False 时不再自动触发） |
| last_executed_at | DateTime | NULL | 上次实际执行时间（UTC） |
| execution_count | Integer | DEFAULT 0 | 该规则累计已执行次数 |
| last_execution_status | String(32) | NULL | 上次执行状态（success/failed 等） |
| last_execution_error | String(512) | NULL | 上次执行失败时的错误信息 |
| created_at | DateTime | DEFAULT UTC_NOW | 记录创建时间（UTC） |
| updated_at | DateTime | DEFAULT UTC_NOW, ON UPDATE | 记录最近更新时间（UTC） |

**关系**：
- 1:N → `task_batches`（一个规则可以生成多个任务批次）

**索引**：
- PRIMARY KEY (id)

---

### 6. nvr_configs（NVR基础配置表）

**表说明**：存储NVR的基本信息。

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | Integer | PK, AI, Index | 主键ID |
| nvr_ip | String(64) | NOT NULL, UNIQUE, Index | NVR IP地址 |
| parking_name | String(128) | NOT NULL | 车场名称 |
| nvr_username | String(64) | NOT NULL | NVR账号 |
| nvr_password | String(128) | NOT NULL | NVR密码 |
| nvr_port | Integer | NOT NULL, DEFAULT 554 | NVR端口 |
| db_host | String(64) | NULL | 数据库地址（用于查询车位坐标） |
| db_user | String(64) | NULL | 数据库账号 |
| db_password | String(128) | NULL | 数据库密码 |
| db_port | Integer | NULL, DEFAULT 3306 | 数据库端口 |
| db_name | String(64) | NULL | 数据库名称 |
| created_at | DateTime | DEFAULT UTC_NOW | 记录创建时间（UTC） |
| updated_at | DateTime | DEFAULT UTC_NOW, ON UPDATE | 记录最近更新时间（UTC） |

**关系**：
- 1:N → `channel_configs`（一个NVR有多个通道配置）

**索引**：
- PRIMARY KEY (id)
- UNIQUE (nvr_ip)
- INDEX (nvr_ip)

**特殊说明**：
- `db_*` 字段用于连接外部数据库查询车位坐标（可选）

---

### 7. channel_configs（通道配置表）

**表说明**：存储每个通道的详细信息。

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | Integer | PK, AI, Index | 主键ID |
| nvr_config_id | Integer | NOT NULL, FK, Index | 关联的NVR配置ID |
| channel_code | String(16) | NOT NULL | 通道编号（如 c1/c2/c3/c4） |
| camera_ip | String(64) | NULL | 摄像头IP地址 |
| camera_name | String(128) | NULL | 摄像头名称 |
| camera_sn | String(64) | NULL, Index | 摄像头SN |
| track_space | String(2048) | NULL | 识别停车区域坐标（track_space 原始值，JSON格式） |
| created_at | DateTime | DEFAULT UTC_NOW | 记录创建时间（UTC） |
| updated_at | DateTime | DEFAULT UTC_NOW, ON UPDATE | 记录最近更新时间（UTC） |

**关系**：
- N:1 → `nvr_configs`（多个通道属于一个NVR）
- 1:N → `parking_spaces`（一个通道有多个车位）
- 1:N → `parking_changes`（一个通道关联多个车位变化记录）
- 1:N → `parking_change_snapshots`（一个通道关联多个快照记录）

**索引**：
- PRIMARY KEY (id)
- INDEX (nvr_config_id)
- INDEX (camera_sn)
- FOREIGN KEY (nvr_config_id) REFERENCES nvr_configs(id) ON DELETE CASCADE

**特殊说明**：
- `track_space` 存储JSON格式的跟踪区域坐标，用于车位检测的回退方案

---

### 8. parking_spaces（车位信息表）

**表说明**：存储每个通道关联的车位编号和坐标。

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | Integer | PK, AI, Index | 主键ID |
| channel_config_id | Integer | NOT NULL, FK, Index | 关联的通道配置ID |
| space_name | String(64) | NOT NULL | 车位编号（如 GXSL091） |
| bbox_x1 | Integer | NOT NULL | 边界框左上角X坐标（实际含义：x） |
| bbox_y1 | Integer | NOT NULL | 边界框左上角Y坐标（实际含义：y） |
| bbox_x2 | Integer | NOT NULL | 边界框右下角X坐标（实际含义：width） |
| bbox_y2 | Integer | NOT NULL | 边界框右下角Y坐标（实际含义：height） |
| created_at | DateTime | DEFAULT UTC_NOW | 记录创建时间（UTC） |
| updated_at | DateTime | DEFAULT UTC_NOW, ON UPDATE | 记录最近更新时间（UTC） |

**关系**：
- N:1 → `channel_configs`（多个车位属于一个通道）
- 1:N → `parking_changes`（一个车位关联多个变化记录）

**索引**：
- PRIMARY KEY (id)
- INDEX (channel_config_id)
- FOREIGN KEY (channel_config_id) REFERENCES channel_configs(id) ON DELETE CASCADE

**重要说明**：
- **坐标格式**：虽然字段名为 `bbox_x1/bbox_y1/bbox_x2/bbox_y2`，但实际存储格式是 `[x, y, width, height]`
  - `bbox_x1` = x（左上角X坐标）
  - `bbox_y1` = y（左上角Y坐标）
  - `bbox_x2` = width（宽度）
  - `bbox_y2` = height（高度）
- 这是为了兼容历史数据格式，在代码中会进行相应转换

---

### 9. parking_changes（车位变化明细表）

**表说明**：记录每张截图中每个车位的占用状态变化。

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | Integer | PK, AI, Index | 主键ID |
| task_id | Integer | NOT NULL, FK, Index | 关联的任务ID（外键：tasks.id） |
| screenshot_id | Integer | NOT NULL, FK, Index | 关联的截图ID（外键：screenshots.id） |
| channel_config_id | Integer | NULL, FK, Index | 关联的通道配置ID（外键：channel_configs.id） |
| space_id | Integer | NULL, FK, Index | 关联的车位ID（外键：parking_spaces.id） |
| space_name | String(64) | NULL | 车位编号（冗余字段，用于直接说明是哪一个车位发生变化） |
| prev_occupied | Boolean | NULL | 上一张图中该车位是否有车（NULL 表示无历史记录） |
| curr_occupied | Boolean | NOT NULL | 当前截图中该车位是否有车 |
| change_type | String(32) | NULL | 变化类型：arrive（进车）/leave（离开）/unknown（无法明确）/NULL（无变化） |
| detection_confidence | Float | NULL | 检测置信度（0.0-1.0），表示检测到车辆的置信度 |
| detected_at | DateTime | DEFAULT UTC_NOW | 变化判定时间 |
| created_at | DateTime | DEFAULT UTC_NOW | 记录创建时间（UTC） |

**关系**：
- N:1 → `tasks`（多个变化记录属于一个任务）
- N:1 → `screenshots`（多个变化记录属于一张截图）
- N:1 → `channel_configs`（多个变化记录属于一个通道）
- N:1 → `parking_spaces`（多个变化记录属于一个车位）

**索引**：
- PRIMARY KEY (id)
- INDEX (task_id)
- INDEX (screenshot_id)
- INDEX (channel_config_id)
- INDEX (space_id)
- FOREIGN KEY (task_id) REFERENCES tasks(id)
- FOREIGN KEY (screenshot_id) REFERENCES screenshots(id)
- FOREIGN KEY (channel_config_id) REFERENCES channel_configs(id) ON DELETE SET NULL
- FOREIGN KEY (space_id) REFERENCES parking_spaces(id) ON DELETE SET NULL

**特殊说明**：
- **所有车位都会记录**：无论是否有变化，每个车位的状态都会记录
- `change_type = NULL` 表示无变化或第一张图（作为基准）
- `prev_occupied = NULL` 表示第一张截图（无历史记录）
- `detection_confidence` 记录YOLO检测的置信度，用于多帧确认机制

---

### 10. parking_change_snapshots（车位变化快照表）

**表说明**：用于快速查询有车位变化的截图列表。每条记录代表某张截图上存在至少一个车位变化。

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | Integer | PK, AI, Index | 主键ID |
| task_id | Integer | NOT NULL, FK, Index | 关联的任务ID（外键：tasks.id） |
| screenshot_id | Integer | NOT NULL, FK, Index | 关联的截图ID（外键：screenshots.id） |
| channel_config_id | Integer | NULL, FK, Index | 关联的通道配置ID（外键：channel_configs.id） |
| ip | String(64) | NULL, Index | 摄像机 IP（冗余，用于检索和展示） |
| channel_code | String(16) | NULL, Index | 通道编码（如 c1/c2/c3/c4，冗余用于检索和展示） |
| parking_name | String(128) | NULL | 车场名称（冗余自 NvrConfig.parking_name） |
| change_count | Integer | NOT NULL, DEFAULT 0 | 本次截图中发生变化的车位数量 |
| detected_at | DateTime | DEFAULT UTC_NOW | 变化判定时间 |
| created_at | DateTime | DEFAULT UTC_NOW | 记录创建时间（UTC） |

**关系**：
- N:1 → `tasks`（多个快照记录属于一个任务）
- N:1 → `screenshots`（多个快照记录属于一张截图）
- N:1 → `channel_configs`（多个快照记录属于一个通道）

**索引**：
- PRIMARY KEY (id)
- INDEX (task_id)
- INDEX (screenshot_id)
- INDEX (channel_config_id)
- INDEX (ip)
- INDEX (channel_code)
- FOREIGN KEY (task_id) REFERENCES tasks(id)
- FOREIGN KEY (screenshot_id) REFERENCES screenshots(id)
- FOREIGN KEY (channel_config_id) REFERENCES channel_configs(id) ON DELETE SET NULL

**特殊说明**：
- **只记录有变化的截图**：只有当 `change_count > 0` 时才创建快照记录
- 用于前端"车位变化"页面快速查询和展示
- `ip`、`channel_code`、`parking_name` 为冗余字段，用于提高查询性能

---

## 四、表关系详细说明

### 4.1 核心业务关系

```
NvrConfig (1) ──< (N) ChannelConfig (1) ──< (N) ParkingSpace
    │                    │                        │
    │                    │                        │
    │                    └────────────────────────┴──> ParkingChange
    │                                                    ParkingChangeSnapshot
    │
AutoScheduleRule (1) ──< (N) TaskBatch (1) ──< (N) Task (1) ──< (N) Screenshot (1) ──< (1) OcrResult
                                                                        │
                                                                        └──> ParkingChange
                                                                             ParkingChangeSnapshot
```

### 4.2 外键约束说明

| 外键字段 | 引用表 | 删除策略 | 说明 |
|---------|--------|---------|------|
| task_batches.created_from_rule_id | auto_schedule_rules.id | - | 规则删除不影响批次 |
| tasks.batch_id | task_batches.id | - | 批次删除不影响任务 |
| screenshots.task_id | tasks.id | - | 任务删除不影响截图 |
| ocr_results.screenshot_id | screenshots.id | - | 截图删除不影响OCR |
| channel_configs.nvr_config_id | nvr_configs.id | CASCADE | NVR删除时级联删除通道 |
| parking_spaces.channel_config_id | channel_configs.id | CASCADE | 通道删除时级联删除车位 |
| parking_changes.task_id | tasks.id | - | 任务删除不影响变化记录 |
| parking_changes.screenshot_id | screenshots.id | - | 截图删除不影响变化记录 |
| parking_changes.channel_config_id | channel_configs.id | SET NULL | 通道删除时设为NULL |
| parking_changes.space_id | parking_spaces.id | SET NULL | 车位删除时设为NULL |
| parking_change_snapshots.task_id | tasks.id | - | 任务删除不影响快照 |
| parking_change_snapshots.screenshot_id | screenshots.id | - | 截图删除不影响快照 |
| parking_change_snapshots.channel_config_id | channel_configs.id | SET NULL | 通道删除时设为NULL |

---

## 五、索引设计

### 5.1 主键索引

所有表都有自增主键 `id`，作为 PRIMARY KEY。

### 5.2 外键索引

所有外键字段都建立了索引，提高关联查询性能。

### 5.3 业务索引

| 表名 | 索引字段 | 用途 |
|------|---------|------|
| task_batches | date, ip, channel | 按日期、IP、通道查询批次 |
| tasks | date, ip, channel | 按日期、IP、通道查询任务 |
| screenshots | task_id | 按任务查询截图 |
| channel_configs | nvr_config_id, camera_sn | 按NVR、SN查询通道 |
| parking_spaces | channel_config_id | 按通道查询车位 |
| parking_changes | task_id, screenshot_id, channel_config_id, space_id | 多维度查询变化记录 |
| parking_change_snapshots | task_id, screenshot_id, channel_config_id, ip, channel_code | 快速查询有变化的截图 |

---

## 六、数据类型说明

### 6.1 时间类型

- **DateTime**：存储 UTC 时间，应用层负责时区转换
- **BigInteger**：存储 Unix 时间戳（秒）

### 6.2 字符串类型

- **String(10)**：日期格式（YYYY-MM-DD）
- **String(16)**：通道编号（c1-c4）
- **String(19)**：时间格式（YYYY-MM-DD HH:MM:SS）
- **String(32)**：状态字段
- **String(64)**：IP地址、SN等
- **String(128)**：名称字段
- **String(512)**：路径、URL等
- **String(2048)**：JSON字符串（track_space）

### 6.3 数值类型

- **Integer**：ID、计数、端口等
- **BigInteger**：时间戳
- **Float**：置信度、浮点数
- **Boolean**：布尔值

---

## 七、数据完整性约束

### 7.1 唯一约束

- `nvr_configs.nvr_ip`：NVR IP 必须唯一
- `ocr_results.screenshot_id`：一张截图只能有一个OCR结果

### 7.2 非空约束

- 所有主键字段：NOT NULL
- 关键业务字段：NOT NULL（如 date, rtsp_url, file_path 等）

### 7.3 默认值

- `status` 字段：默认 'pending'
- `is_enabled` 字段：默认 True
- `is_duplicate` 字段：默认 False
- `retry_count` 字段：默认 0
- `created_at` 字段：默认当前UTC时间
- `updated_at` 字段：默认当前UTC时间，更新时自动更新

---

## 八、数据流转说明

### 8.1 任务创建流程

```
AutoScheduleRule (规则)
    ↓
TaskBatch (批次)
    ↓
Task (任务明细)
```

### 8.2 截图处理流程

```
Task (任务)
    ↓
Screenshot (截图)
    ↓
OcrResult (OCR结果，可选)
```

### 8.3 车位变化检测流程

```
Screenshot (截图)
    ↓
ParkingChange (车位变化明细，所有车位)
    ↓
ParkingChangeSnapshot (快照，只记录有变化的)
```

### 8.4 配置管理流程

```
NvrConfig (NVR配置)
    ↓
ChannelConfig (通道配置)
    ↓
ParkingSpace (车位信息)
```

---

## 九、特殊字段说明

### 9.1 坐标字段（parking_spaces）

**重要**：虽然字段名为 `bbox_x1/bbox_y1/bbox_x2/bbox_y2`，但实际存储格式是 `[x, y, width, height]`：

- `bbox_x1` = x（左上角X坐标）
- `bbox_y1` = y（左上角Y坐标）
- `bbox_x2` = width（宽度）
- `bbox_y2` = height（高度）

这是为了兼容历史数据格式，在代码中会进行相应转换。

### 9.2 状态字段

- **task_batches.status**：pending/running/completed/failed/partial_failed
- **tasks.status**：pending/playing/completed/failed
- **screenshots.yolo_status**：pending/processing/done/failed
- **parking_changes.change_type**：arrive/leave/unknown/NULL

### 9.3 JSON字段

- **channel_configs.track_space**：存储JSON格式的跟踪区域坐标
  - 格式：`[x1, y1, x2, y2]` 或 `{"x1": ..., "y1": ..., "x2": ..., "y2": ...}`
  - 用于车位检测的回退方案

---

## 十、性能优化建议

### 10.1 查询优化

1. **按日期查询**：使用 `date` 字段索引
2. **按IP/通道查询**：使用 `ip`、`channel` 字段索引
3. **关联查询**：使用外键索引
4. **时间范围查询**：使用 `start_ts`、`end_ts` 字段（建议添加索引）

### 10.2 数据清理

1. **定期清理**：删除过期的任务、截图数据
2. **归档策略**：将历史数据归档到备份表
3. **索引维护**：定期优化表索引

### 10.3 冗余字段

- `tasks.ip`、`tasks.channel`：从 `rtsp_url` 冗余解析，提高查询性能
- `parking_changes.space_name`：冗余存储车位名称，避免关联查询
- `parking_change_snapshots.ip`、`channel_code`、`parking_name`：冗余存储，提高查询性能

---

## 十一、数据库初始化

### 11.1 创建数据库

```sql
CREATE DATABASE smart_rtsp DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 11.2 自动创建表

应用启动时（`app/main.py` 的 `lifespan` 函数）会自动执行：

```python
Base.metadata.create_all(bind=engine)
```

所有表结构会根据 `models.py` 中的定义自动创建。

### 11.3 环境变量配置

```bash
MYSQL_USER=root
MYSQL_PASSWORD=test123456
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_DB=smart_rtsp
```

---

## 十二、数据备份建议

### 12.1 备份策略

1. **全量备份**：每天备份一次
2. **增量备份**：每小时备份一次
3. **关键表备份**：`parking_changes`、`parking_change_snapshots` 建议单独备份

### 12.2 备份命令

```bash
# 全量备份
mysqldump -u root -p smart_rtsp > backup_$(date +%Y%m%d).sql

# 只备份表结构
mysqldump -u root -p --no-data smart_rtsp > schema.sql
```

---

## 十三、版本历史

- **v1.0**：初始版本，包含基础任务和截图管理
- **v2.0**：添加自动排程规则和任务批次
- **v3.0**：添加NVR配置、通道配置、车位信息
- **v4.0**：添加车位变化检测（parking_changes、parking_change_snapshots）
- **v4.1**：添加 `detection_confidence` 字段到 `parking_changes`

---

## 十四、注意事项

1. **时区处理**：所有时间字段存储为 UTC，前端显示时需要转换为本地时间
2. **字符集**：使用 utf8mb4 支持 emoji 等特殊字符
3. **外键约束**：部分外键使用 `ON DELETE SET NULL`，删除父记录时子记录不会级联删除
4. **坐标格式**：`parking_spaces` 表的坐标字段实际含义与字段名不一致，需要注意
5. **冗余字段**：部分字段为冗余设计，用于提高查询性能，需要保持数据一致性
